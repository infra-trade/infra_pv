---
# ============================================================================
# PLAY 21 - Instalar Docker (si hace falta) y desplegar Portainer
# ============================================================================

# ---------------------------------------------------------------------------
# 1) Asegurar Docker instalado y habilitado en TODOS los hosts
#    - Si ya hay docker instalado, NO intenta reinstalar ni tocar repos.
#    - Si no est치, lo instala desde los repos de Ubuntu (docker.io).
# ---------------------------------------------------------------------------
- name: 21 - Instalar y habilitar Docker en todos los hosts
  hosts: all
  become: true
  vars:
    docker_packages_ubuntu:
      - docker.io
      - docker-compose-plugin

  tasks:
    - name: Comprobar si Docker ya est치 instalado
      ansible.builtin.command: docker --version
      register: docker_check
      ignore_errors: true
      changed_when: false

    - name: Mostrar estado actual de Docker en el host
      ansible.builtin.debug:
        msg: "Docker ya est치 instalado en {{ inventory_hostname }} (salida: {{ docker_check.stdout }})"
      when: docker_check.rc == 0

    - name: Actualizar cache de paquetes APT (solo si falta Docker)
      ansible.builtin.apt:
        update_cache: yes
      when:
        - ansible_os_family == "Debian"
        - docker_check.rc != 0

    - name: Instalar dependencias base para Docker (solo si falta Docker)
      ansible.builtin.apt:
        name:
          - ca-certificates
          - curl
          - gnupg
          - lsb-release
          - apt-transport-https
          - software-properties-common
        state: present
      when:
        - ansible_os_family == "Debian"
        - docker_check.rc != 0

    - name: Instalar Docker desde los repos de Ubuntu (docker.io) si no est치 instalado
      ansible.builtin.apt:
        name: "{{ docker_packages_ubuntu }}"
        state: present
      when:
        - ansible_distribution == "Ubuntu"
        - docker_check.rc != 0

    - name: Habilitar y arrancar servicio Docker
      ansible.builtin.service:
        name: docker
        state: started
        enabled: true

# ---------------------------------------------------------------------------
# 2) Desplegar Portainer SERVER en pv-infra-master
# ---------------------------------------------------------------------------
- name: 21 - Desplegar Portainer Server en pv-infra-master
  hosts: pv-infra-master
  become: true

  tasks:
    - name: Crear volumen de datos para Portainer (Server)
      ansible.builtin.command:
        cmd: docker volume create portainer_data
      register: portainer_volume_create
      changed_when: "'Error' not in portainer_volume_create.stderr"

    - name: Eliminar contenedor Portainer existente (si lo hay)
      ansible.builtin.command:
        cmd: docker rm -f portainer
      register: remove_portainer
      failed_when: remove_portainer.rc != 0 and 'No such container' not in remove_portainer.stderr
      changed_when: remove_portainer.rc == 0

    - name: Desplegar contenedor Portainer Server
      ansible.builtin.command:
        cmd: >
          docker run -d
          -p 9443:9443
          --name portainer
          --restart=always
          -v /var/run/docker.sock:/var/run/docker.sock
          -v portainer_data:/data
          portainer/portainer-ce:latest
      register: run_portainer
      changed_when: "'Error' not in run_portainer.stderr"

# ---------------------------------------------------------------------------
# 3) Desplegar Portainer AGENT en los nodos (grupo portainer_agents)
#
#    INVENTARIO (ejemplo):
#
#    [pv-infra-master]
#    pv-infra-master
#
#    [portainer_agents]
#    pv-infra-nodo1
#    pv-infra-nodo2
# ---------------------------------------------------------------------------
- name: 21 - Desplegar Portainer Agent en nodos
  hosts: portainer_agents
  become: true

  tasks:
    - name: Crear volumen de datos para Portainer Agent
      ansible.builtin.command:
        cmd: docker volume create portainer_agent_data
      register: portainer_agent_volume_create
      changed_when: "'Error' not in portainer_agent_volume_create.stderr"

    - name: Eliminar contenedor Portainer Agent existente (si lo hay)
      ansible.builtin.command:
        cmd: docker rm -f portainer_agent
      register: remove_portainer_agent
      failed_when: remove_portainer_agent.rc != 0 and 'No such container' not in remove_portainer_agent.stderr
      changed_when: remove_portainer_agent.rc == 0

    - name: Desplegar contenedor Portainer Agent
      ansible.builtin.command:
        cmd: >
          docker run -d
          --name portainer_agent
          --restart=always
          -p 9001:9001
          -v /var/run/docker.sock:/var/run/docker.sock
          -v /var/lib/docker/volumes:/var/lib/docker/volumes
          portainer/agent:latest
      register: run_portainer_agent
      changed_when: "'Error' not in run_portainer_agent.stderr"