---
# ============================================================================
# PLAY 21 - Instalar Docker y desplegar Portainer (Server + Agents)
# Archivo listo para copiar/pegar
# ============================================================================

# ---------------------------------------------------------------------------
# 1) Asegurar Docker instalado y funcionando en TODOS los hosts de infraestructura
#    (master + nodos donde se quiera usar Portainer)
# ---------------------------------------------------------------------------
- name: 21 - Instalar y habilitar Docker en todos los hosts
  hosts: all
  become: true
  vars:
    docker_packages:
      - ca-certificates
      - curl
      - gnupg
      - lsb-release
      - apt-transport-https
      - software-properties-common
      - docker-ce
      - docker-ce-cli
      - containerd.io
      - docker-buildx-plugin
      - docker-compose-plugin

  tasks:
    - name: Actualizar cache de paquetes APT
      ansible.builtin.apt:
        update_cache: yes
      when: ansible_os_family == "Debian"

    - name: Instalar dependencias base para Docker
      ansible.builtin.apt:
        name:
          - ca-certificates
          - curl
          - gnupg
          - lsb-release
          - apt-transport-https
          - software-properties-common
        state: present
      when: ansible_os_family == "Debian"

    - name: Crear directorio para llaves APT (si no existe)
      ansible.builtin.file:
        path: /etc/apt/keyrings
        state: directory
        mode: "0755"
      when: ansible_os_family == "Debian"

    - name: Agregar llave GPG oficial de Docker
      ansible.builtin.get_url:
        url: https://download.docker.com/linux/ubuntu/gpg
        dest: /etc/apt/keyrings/docker.gpg
        mode: "0644"
      when: ansible_distribution == "Ubuntu"

    - name: Configurar repositorio APT de Docker
      ansible.builtin.apt_repository:
        repo: >-
          deb [arch=amd64 signed-by=/etc/apt/keyrings/docker.gpg]
          https://download.docker.com/linux/ubuntu {{ ansible_distribution_release }} stable
        filename: docker
      when: ansible_distribution == "Ubuntu"

    - name: Actualizar cache de paquetes tras agregar repo Docker
      ansible.builtin.apt:
        update_cache: yes
      when: ansible_distribution == "Ubuntu"

    - name: Instalar paquetes de Docker
      ansible.builtin.apt:
        name: "{{ docker_packages }}"
        state: present
      when: ansible_distribution == "Ubuntu"

    - name: Habilitar y arrancar servicio Docker
      ansible.builtin.service:
        name: docker
        state: started
        enabled: true

# ---------------------------------------------------------------------------
# 2) Desplegar Portainer SERVER en pv-infra-master
# ---------------------------------------------------------------------------
- name: 21 - Desplegar Portainer Server en pv-infra-master
  hosts: pv-infra-master
  become: true

  tasks:
    - name: Crear volumen de datos para Portainer (Server)
      ansible.builtin.command:
        cmd: docker volume create portainer_data
      register: portainer_volume_create
      changed_when: "'Error' not in portainer_volume_create.stderr"

    - name: Eliminar contenedor Portainer existente (si lo hay)
      ansible.builtin.command:
        cmd: docker rm -f portainer
      register: remove_portainer
      failed_when: remove_portainer.rc != 0 and 'No such container' not in remove_portainer.stderr
      changed_when: remove_portainer.rc == 0

    - name: Desplegar contenedor Portainer Server
      ansible.builtin.command:
        cmd: >
          docker run -d
          -p 9443:9443
          --name portainer
          --restart=always
          -v /var/run/docker.sock:/var/run/docker.sock
          -v portainer_data:/data
          portainer/portainer-ce:latest
      register: run_portainer
      changed_when: "'Error' not in run_portainer.stderr"

# ---------------------------------------------------------------------------
# 3) Desplegar Portainer AGENT en los nodos (grupo portainer_agents)
#
#    IMPORTANTE:
#    - En tu inventario, define un grupo asÃ­:
#
#      [portainer_agents]
#      nodo1-trade-pruebas
#      nodo2-trade-produccion
#      # ...otros nodos donde quieras el Agent
# ---------------------------------------------------------------------------
- name: 21 - Desplegar Portainer Agent en nodos
  hosts: portainer_agents
  become: true

  tasks:
    - name: Crear volumen de datos para Portainer Agent
      ansible.builtin.command:
        cmd: docker volume create portainer_agent_data
      register: portainer_agent_volume_create
      changed_when: "'Error' not in portainer_agent_volume_create.stderr"

    - name: Eliminar contenedor Portainer Agent existente (si lo hay)
      ansible.builtin.command:
        cmd: docker rm -f portainer_agent
      register: remove_portainer_agent
      failed_when: remove_portainer_agent.rc != 0 and 'No such container' not in remove_portainer_agent.stderr
      changed_when: remove_portainer_agent.rc == 0

    - name: Desplegar contenedor Portainer Agent
      ansible.builtin.command:
        cmd: >
          docker run -d
          --name portainer_agent
          --restart=always
          -p 9001:9001
          -v /var/run/docker.sock:/var/run/docker.sock
          -v /var/lib/docker/volumes:/var/lib/docker/volumes
          portainer/agent:latest
      register: run_portainer_agent
      changed_when: "'Error' not in run_portainer_agent.stderr"