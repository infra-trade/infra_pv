---
- name: "Base de infraestructura: Docker, Portainer, NTP, herramientas de red"
  hosts: "pv_infra_master:pv_infra_nodes"
  become: true
  become_method: sudo
  become_user: root
  gather_facts: true

  vars:
    tz: "America/Costa_Rica"
    ntp_pkg: "chrony"
    ntp_service: "chrony"

  tasks:
    - name: Mostrar host sobre el que se está trabajando
      ansible.builtin.debug:
        msg: "Configurando {{ inventory_hostname }} (ansible_host={{ ansible_host | default('desconocida') }}) en grupos {{ group_names }}"

    - name: Actualizar caché de APT
      ansible.builtin.apt:
        update_cache: true
        cache_valid_time: 3600

    - name: Instalar paquetes base de red y troubleshooting
      ansible.builtin.apt:
        name:
          - "{{ ntp_pkg }}"
          - htop
          - tcpdump
          - iputils-ping
          - net-tools
          - nmap
        state: present

    - name: Configurar zona horaria a Costa Rica
      ansible.builtin.command: "timedatectl set-timezone {{ tz }}"
      when: ansible_facts['os_family'] == "Debian"

    - name: Habilitar y arrancar servicio NTP
      ansible.builtin.service:
        name: "{{ ntp_service }}"
        state: started
        enabled: true

    - name: Instalar Docker Engine y herramientas
      ansible.builtin.apt:
        name:
          - docker.io
          - docker-compose-plugin
        state: present

    - name: Asegurar que Docker está habilitado y en ejecución
      ansible.builtin.service:
        name: docker
        state: started
        enabled: true

    - name: Agregar usuario pvinfra al grupo docker
      ansible.builtin.user:
        name: "pvinfra"
        groups: "docker"
        append: true1

    # ----------------- Portainer Server en el master -------------------
    - name: Crear volumen de datos para Portainer Server (solo master)
      ansible.builtin.shell: |
        docker volume create portainer_data >/dev/null 2>&1 || true
      args:
        warn: false
      when: "'pv_infra_master' in group_names"

    - name: Desplegar/actualizar Portainer Server en el master
      ansible.builtin.shell: |
        docker stop portainer >/dev/null 2>&1 || true
        docker rm portainer >/dev/null 2>&1 || true
        docker run -d \
          --name portainer \
          --restart=always \
          -p 9000:9000 \
          -p 9443:9443 \
          -v /var/run/docker.sock:/var/run/docker.sock \
          -v portainer_data:/data \
          portainer/portainer-ce:latest
      args:
        warn: false
      when: "'pv_infra_master' in group_names"

    # ----------------- Portainer Agent en los nodos --------------------
    - name: Desplegar/actualizar Portainer Agent en nodos
      ansible.builtin.shell: |
        docker stop portainer_agent >/dev/null 2>&1 || true
        docker rm portainer_agent >/dev/null 2>&1 || true
        docker run -d \
          --name portainer_agent \
          --restart=always \
          -p 9001:9001 \
          -v /var/run/docker.sock:/var/run/docker.sock \
          -v /var/lib/docker/volumes:/var/lib/docker/volumes \
          portainer/agent:latest
      args:
        warn: false
      when: "'pv_infra_nodes' in group_names"