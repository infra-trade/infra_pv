---
- name: 21 - Instalar y habilitar Docker + docker-compose en todos los hosts
  hosts: docker_hosts
  become: true

  vars:
    # Paquetes Docker principales
    docker_base_packages:
      - docker.io
      - docker-compose

  tasks:
    - name: Actualizar cache de paquetes APT
      ansible.builtin.apt:
        update_cache: yes
        cache_valid_time: 3600

    - name: Instalar Docker y docker-compose (binario v1)
      ansible.builtin.apt:
        name: "{{ docker_base_packages }}"
        state: present

    - name: Intentar instalar docker-compose-plugin (para 'docker compose' v2, si existe en el repo)
      ansible.builtin.apt:
        name: docker-compose-plugin
        state: present
      failed_when: false

    - name: Asegurar que el grupo docker existe
      ansible.builtin.group:
        name: docker
        state: present

    - name: Agregar usuario pvinfra al grupo docker
      ansible.builtin.user:
        name: pvinfra
        groups: docker
        append: true

    - name: Habilitar y arrancar servicio Docker
      ansible.builtin.systemd:
        name: docker
        state: started
        enabled: true

    - name: Comprobar versi칩n de Docker instalada
      ansible.builtin.command:
        cmd: docker --version
      register: docker_version
      changed_when: false
      failed_when: false

    - name: Mostrar versi칩n de Docker en el host
      ansible.builtin.debug:
        msg: "Docker en {{ inventory_hostname }} => {{ docker_version.stdout | default('no disponible') }}"

    - name: Comprobar si 'docker compose' (plugin v2) est치 disponible
      ansible.builtin.command: docker compose version
      register: docker_compose_v2
      changed_when: false
      failed_when: false

    - name: Comprobar si 'docker-compose' (binario v1) est치 disponible
      ansible.builtin.command: docker-compose --version
      register: docker_compose_v1
      changed_when: false
      failed_when: false

    - name: Mostrar comandos docker-compose disponibles
      ansible.builtin.debug:
        msg: >
          En {{ inventory_hostname }}:
          docker compose rc={{ docker_compose_v2.rc }},
          docker-compose rc={{ docker_compose_v1.rc }}

# ----------------------------------------------------------------------

- name: 21 - Desplegar Portainer Server en pv-infra-master (reset completo)
  hosts: portainer_server
  become: true

  vars:
    portainer_image: "portainer/portainer-ce:latest"
    portainer_container_name: "portainer"
    portainer_volume_name: "portainer_data"

  tasks:
    - name: Eliminar contenedor Portainer existente (si lo hay)
      ansible.builtin.command:
        cmd: docker rm -f {{ portainer_container_name }}
      register: remove_portainer_result
      failed_when: false
      changed_when: remove_portainer_result.rc == 0

    - name: Eliminar volumen de datos Portainer (RESET de la base de datos)
      ansible.builtin.command:
        cmd: docker volume rm {{ portainer_volume_name }}
      register: remove_portainer_volume_result
      failed_when: false
      changed_when: remove_portainer_volume_result.rc == 0

    - name: Crear volumen de datos para Portainer (Server)
      ansible.builtin.command:
        cmd: docker volume create {{ portainer_volume_name }}
      register: portainer_volume
      changed_when: "'{{ portainer_volume_name }}' in portainer_volume.stdout"

    - name: Descargar imagen {{ portainer_image }} con reintentos
      ansible.builtin.command:
        cmd: docker pull {{ portainer_image }}
      register: pull_portainer_result
      retries: 3
      delay: 10
      until: pull_portainer_result.rc == 0
      failed_when: pull_portainer_result.rc != 0

    - name: Desplegar contenedor Portainer Server
      ansible.builtin.command: >
        docker run -d
        -p 9443:9443
        --name {{ portainer_container_name }}
        --restart=always
        -v /var/run/docker.sock:/var/run/docker.sock
        -v {{ portainer_volume_name }}:/data
        {{ portainer_image }}
      register: run_portainer_result
      changed_when: run_portainer_result.rc == 0

# ----------------------------------------------------------------------

- name: 21 - Desplegar Portainer Agent en nodos (reset completo)
  hosts: portainer_agents
  become: true

  vars:
    portainer_agent_image: "portainer/agent:latest"
    portainer_agent_container_name: "portainer_agent"
    portainer_agent_volume_name: "portainer_agent_data"

  tasks:
    - name: Eliminar contenedor Portainer Agent existente (si lo hay)
      ansible.builtin.command:
        cmd: docker rm -f {{ portainer_agent_container_name }}
      register: remove_agent_result
      failed_when: false
      changed_when: remove_agent_result.rc == 0

    - name: Eliminar volumen de datos Portainer Agent (para un reset completo)
      ansible.builtin.command:
        cmd: docker volume rm {{ portainer_agent_volume_name }}
      register: remove_agent_volume_result
      failed_when: false
      changed_when: remove_agent_volume_result.rc == 0

    - name: Crear volumen de datos para Portainer Agent
      ansible.builtin.command:
        cmd: docker volume create {{ portainer_agent_volume_name }}
      register: portainer_agent_volume
      changed_when: "'{{ portainer_agent_volume_name }}' in portainer_agent_volume.stdout"

    - name: Descargar imagen {{ portainer_agent_image }} con reintentos
      ansible.builtin.command:
        cmd: docker pull {{ portainer_agent_image }}
      register: pull_agent_result
      retries: 3
      delay: 10
      until: pull_agent_result.rc == 0
      failed_when: pull_agent_result.rc != 0

    - name: Desplegar contenedor Portainer Agent
      ansible.builtin.command: >
        docker run -d
        --name {{ portainer_agent_container_name }}
        --restart=always
        -p 9001:9001
        -v /var/run/docker.sock:/var/run/docker.sock
        -v /var/lib/docker/volumes:/var/lib/docker/volumes
        {{ portainer_agent_image }}
      register: run_agent_result
      changed_when: run_agent_result.rc == 0