---
- name: 21 - Instalar y habilitar Docker en todos los hosts
  hosts: docker_hosts
  become: true

  vars:
    infra_base_dir: "/srv/infra"
    noc_base_dir: "/srv/noc"
    soc_base_dir: "/srv/soc"

  tasks:
    - name: Comprobar si Docker ya está instalado
      ansible.builtin.command:
        cmd: docker --version
      register: docker_check
      failed_when: false
      changed_when: false

    - name: Mostrar estado actual de Docker en el host
      ansible.builtin.debug:
        msg: "Docker ya está instalado en {{ inventory_hostname }} (salida: {{ docker_check.stdout }})"
      when: docker_check.rc == 0

    - name: Actualizar cache de paquetes APT (solo si falta Docker)
      ansible.builtin.apt:
        update_cache: yes
        cache_valid_time: 3600
      when: docker_check.rc != 0

    - name: Instalar dependencias base para Docker (solo si falta Docker)
      ansible.builtin.apt:
        name:
          - apt-transport-https
          - ca-certificates
          - curl
          - git
        state: present
      when: docker_check.rc != 0

    - name: Instalar Docker desde los repos de Ubuntu (docker.io) si no está instalado
      ansible.builtin.apt:
        name:
          - docker.io
        state: present
      when: docker_check.rc != 0

    - name: Habilitar y arrancar servicio Docker
      ansible.builtin.systemd:
        name: docker
        state: started
        enabled: true

    # ------------------------------------------------------------------
    # Estructura de directorios para bind-mounts según rol del host
    # ------------------------------------------------------------------

    # MASTER: iTop (mesa de ayuda) y estructura infra genérica
    - name: Crear estructura bind-mount para servicios INFRA en pv-infra-master
      ansible.builtin.file:
        path: "{{ infra_base_dir }}/{{ item }}"
        state: directory
        owner: root
        group: root
        mode: "0755"
      loop:
        - config
        - data
        - logs
        - itop
        - itop/config
        - itop/data
      when: inventory_hostname == "pv-infra-master"

    # NOC: Prometheus, Grafana, Netdata, etc.
    - name: Crear estructura bind-mount para NOC en pv-infra-noc
      ansible.builtin.file:
        path: "{{ noc_base_dir }}/{{ item }}"
        state: directory
        owner: root
        group: root
        mode: "0755"
      loop:
        - config
        - data
        - logs
        - prometheus
        - prometheus/config
        - prometheus/data
        - grafana
        - grafana/data
        - netdata
        - netdata/config
      when: inventory_hostname == "pv-infra-noc"

    # SOC: OpenCTI, Gophish, Wazuh, etc.
    - name: Crear estructura bind-mount para SOC en pv-infra-soc
      ansible.builtin.file:
        path: "{{ soc_base_dir }}/{{ item }}"
        state: directory
        owner: root
        group: root
        mode: "0755"
      loop:
        - config
        - data
        - logs
        - opencti
        - opencti/data
        - gophish
        - gophish/config
        - wazuh
        - wazuh/data
      when: inventory_hostname == "pv-infra-soc"

# ----------------------------------------------------------------------

- name: 21 - Desplegar Portainer Server en pv-infra-master
  hosts: portainer_server
  become: true

  tasks:
    - name: Crear volumen de datos para Portainer (Server)
      ansible.builtin.command:
        cmd: docker volume create portainer_data
      register: portainer_volume
      changed_when: "'portainer_data' in portainer_volume.stdout"

    - name: Eliminar contenedor Portainer existente (si lo hay)
      ansible.builtin.command:
        cmd: docker rm -f portainer
      register: remove_portainer_result
      failed_when: false
      changed_when: remove_portainer_result.rc == 0

    - name: Descargar imagen portainer/portainer-ce:latest con reintentos
      ansible.builtin.command:
        cmd: docker pull portainer/portainer-ce:latest
      register: pull_portainer_result
      retries: 3
      delay: 10
      until: pull_portainer_result.rc == 0
      failed_when: pull_portainer_result.rc != 0

    - name: Desplegar contenedor Portainer Server
      ansible.builtin.command: >
        docker run -d
        -p 9443:9443
        --name portainer
        --restart=always
        -v /var/run/docker.sock:/var/run/docker.sock
        -v portainer_data:/data
        portainer/portainer-ce:latest
      register: run_portainer_result
      changed_when: run_portainer_result.rc == 0

# ----------------------------------------------------------------------

- name: 21 - Desplegar Portainer Agent en nodos
  hosts: portainer_agents
  become: true

  tasks:
    - name: Crear volumen de datos para Portainer Agent
      ansible.builtin.command:
        cmd: docker volume create portainer_agent_data
      register: portainer_agent_volume
      changed_when: "'portainer_agent_data' in portainer_agent_volume.stdout"

    - name: Eliminar contenedor Portainer Agent existente (si lo hay)
      ansible.builtin.command:
        cmd: docker rm -f portainer_agent
      register: remove_agent_result
      failed_when: false
      changed_when: remove_agent_result.rc == 0

    - name: Descargar imagen portainer/agent:latest con reintentos
      ansible.builtin.command:
        cmd: docker pull portainer/agent:latest
      register: pull_agent_result
      retries: 3
      delay: 10
      until: pull_agent_result.rc == 0
      failed_when: pull_agent_result.rc != 0

    - name: Desplegar contenedor Portainer Agent
      ansible.builtin.command: >
        docker run -d
        --name portainer_agent
        --restart=always
        -p 9001:9001
        -v /var/run/docker.sock:/var/run/docker.sock
        -v /var/lib/docker/volumes:/var/lib/docker/volumes
        portainer/agent:latest
      register: run_agent_result
      changed_when: run_agent_result.rc == 0