---
- name: Base de infraestructura: Docker, Portainer, NTP, herramientas de red
  hosts: pv_infra_master:pv_infra_nodes
  gather_facts: true
  become: true

  vars:
    # Zona horaria para todas las VMs
    target_timezone: "America/Costa_Rica"

    # Imagenes de Portainer
    portainer_image: "portainer/portainer-ce:latest"
    portainer_agent_image: "portainer/agent:latest"

  tasks:
    #####################################################################
    # 1. Paquetes base y herramientas de troubleshooting
    #####################################################################
    - name: Actualizar índice de paquetes APT
      ansible.builtin.apt:
        update_cache: yes
        cache_valid_time: 3600

    - name: Instalar herramientas de red y utilidades básicas
      ansible.builtin.apt:
        name:
          - ca-certificates
          - curl
          - gnupg
          - lsb-release
          - apt-transport-https
          - software-properties-common
          - iputils-ping
          - traceroute
          - dnsutils
          - net-tools
          - tcpdump
          - mtr-tiny
          - htop
          - vim
          - wget
        state: present

    #####################################################################
    # 2. NTP + Zona horaria Costa Rica
    #####################################################################
    - name: Instalar chrony para NTP
      ansible.builtin.apt:
        name: chrony
        state: present

    - name: Habilitar y arrancar servicio chrony
      ansible.builtin.systemd:
        name: chrony
        enabled: yes
        state: started

    - name: Configurar timezone a America/Costa_Rica
      ansible.builtin.command: timedatectl set-timezone "{{ target_timezone }}"
      changed_when: false

    #####################################################################
    # 3. Docker en todos los hosts
    #####################################################################
    - name: Instalar Docker desde repositorios de Ubuntu
      ansible.builtin.apt:
        name: docker.io
        state: present

    - name: Habilitar y arrancar servicio Docker
      ansible.builtin.systemd:
        name: docker
        enabled: yes
        state: started

    - name: Agregar usuario actual de Ansible al grupo docker
      ansible.builtin.user:
        name: "{{ ansible_user }}"
        groups: docker
        append: yes

    #####################################################################
    # 4. Portainer SERVER en el master
    #####################################################################
    - name: Eliminar contenedor Portainer existente (si lo hay) en master
      ansible.builtin.shell: |
        if docker ps -a --format '{{.Names}}' | grep -q '^portainer$'; then
          docker rm -f portainer
        fi
      when: "'pv_infra_master' in group_names"

    - name: Crear volumen de datos para Portainer en master
      ansible.builtin.shell: |
        docker volume create portainer_data >/dev/null 2>&1 || true
      when: "'pv_infra_master' in group_names"

    - name: Desplegar Portainer SERVER en master
      ansible.builtin.shell: |
        docker run -d \
          --name portainer \
          --restart=always \
          -p 8000:8000 \
          -p 9443:9443 \
          -v /var/run/docker.sock:/var/run/docker.sock \
          -v portainer_data:/data \
          {{ portainer_image }}
      args:
        warn: false
      when: "'pv_infra_master' in group_names"

    #####################################################################
    # 5. Portainer AGENT en los nodos
    #####################################################################
    - name: Eliminar contenedor Portainer Agent existente (si lo hay) en nodos
      ansible.builtin.shell: |
        if docker ps -a --format '{{.Names}}' | grep -q '^portainer_agent$'; then
          docker rm -f portainer_agent
        fi
      when: "'pv_infra_nodes' in group_names"

    - name: Desplegar Portainer AGENT en nodos
      ansible.builtin.shell: |
        docker run -d \
          --name portainer_agent \
          --restart=always \
          -p 9001:9001 \
          -v /var/run/docker.sock:/var/run/docker.sock \
          -v /var/lib/docker/volumes:/var/lib/docker/volumes \
          {{ portainer_agent_image }}
      args:
        warn: false
      when: "'pv_infra_nodes' in group_names"