---
- name: Base de infraestructura: Docker, Portainer, NTP, herramientas de red
  hosts: all
  become: true
  gather_facts: true

  tasks:
    - name: Mostrar host sobre el que se está trabajando
      ansible.builtin.debug:
        msg: "Configurando {{ inventory_hostname }} (ansible_host={{ ansible_host }}) en grupos {{ group_names }}"

    - name: Actualizar caché de APT
      ansible.builtin.apt:
        update_cache: yes
        cache_valid_time: 3600

    - name: Instalar paquetes base de red y troubleshooting
      ansible.builtin.apt:
        name:
          - chrony
          - htop
          - iputils-ping
          - net-tools
          - nmap
          - tcpdump
        state: present

    - name: Configurar zona horaria a Costa Rica
      ansible.builtin.command: timedatectl set-timezone America/Costa_Rica

    - name: Habilitar y arrancar servicio NTP
      ansible.builtin.service:
        name: chrony
        state: started
        enabled: true

    - name: Instalar Docker Engine
      ansible.builtin.apt:
        name:
          - docker.io
        state: present

    - name: Habilitar y arrancar servicio Docker
      ansible.builtin.service:
        name: docker
        state: started
        enabled: true

    - name: Añadir usuario remoto al grupo docker
      ansible.builtin.user:
        name: "{{ ansible_user | default('pvinfra') }}"
        groups: docker
        append: yes
      when: ansible_user is defined

    # =========================
    # Portainer Server en MASTER
    # =========================
    - name: Crear volumen de datos para Portainer en el master
      ansible.builtin.shell: |
        if ! docker volume ls | awk '{print $2}' | grep -w portainer_data >/dev/null 2>&1; then
          docker volume create portainer_data
        fi
      args:
        warn: false
      when: "'pv_infra_master' in group_names"

    - name: Eliminar contenedor Portainer en el master si ya existe
      ansible.builtin.shell: |
        if docker ps -a | grep -w portainer >/dev/null 2>&1; then
          docker rm -f portainer
        fi
      args:
        warn: false
      when: "'pv_infra_master' in group_names"

    - name: Desplegar Portainer Server en el master
      ansible.builtin.shell: |
        docker run -d \
          -p 8000:8000 \
          -p 9443:9443 \
          --name portainer \
          --restart=always \
          -v /var/run/docker.sock:/var/run/docker.sock \
          -v portainer_data:/data \
          portainer/portainer-ce:latest
      args:
        warn: false
      when: "'pv_infra_master' in group_names"

    # =========================
    # Portainer Agent en NODOS
    # =========================
    - name: Eliminar contenedor Portainer Agent si ya existe
      ansible.builtin.shell: |
        if docker ps -a | grep -w portainer_agent >/dev/null 2>&1; then
          docker rm -f portainer_agent
        fi
      args:
        warn: false
      when: "'pv_infra_nodes' in group_names"

    - name: Desplegar Portainer Agent en nodos
      ansible.builtin.shell: |
        docker run -d \
          -p 9001:9001 \
          --name portainer_agent \
          --restart=always \
          -v /var/run/docker.sock:/var/run/docker.sock \
          -v /var/lib/docker/volumes:/var/lib/docker/volumes \
          portainer/agent:latest
      args:
        warn: false
      when: "'pv_infra_nodes' in group_names"