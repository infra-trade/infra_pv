---
- name: Diagnóstico de autenticación contra vCenter
  hosts: localhost
  connection: local
  gather_facts: false
  vars_files:
    - ../vault.yml

  vars:
    vmware_venv: "{{ lookup('env','HOME') + '/.ansible/venvs/vmware' }}"
    venv_python: "{{ vmware_venv + '/bin/python3' }}"
  pre_tasks:
    - name: Asegurar venv y deps
      block:
        - command: "python3 -m venv {{ vmware_venv }}"
          args: { creates: "{{ venv_python }}" }
        - pip:
            name:
              - pyvmomi>=8.0.2
              - requests>=2.31.0
              - urllib3>=1.26
            virtualenv: "{{ vmware_venv }}"
        - set_fact:
            ansible_python_interpreter: "{{ venv_python }}"

    - name: Resolver endpoint/usuario/clave
      no_log: false
      vars:
        _host_env: "{{ lookup('env','VCENTER_HOSTNAME') | default('', true) }}"
        _user_env: "{{ lookup('env','VCENTER_USERNAME') | default('', true) }}"
        _pass_env: "{{ lookup('env','VCENTER_PASSWORD') | default('', true) }}"
      set_fact:
        _vc_host: >-
          {{ (vcenter_hostname | default('', true)) | default(_host_env, true) | default(vault_vcenter_hostname | default('', true), true) | default('', true) }}
        _vc_user: >-
          {{ (vcenter_username | default('', true)) | default(_user_env, true) | default(vault_vcenter_username | default('', true), true) | default('', true) }}
        _vc_pass: >-
          {{ (vcenter_password | default('', true)) | default(_pass_env, true) | default(vault_vcenter_password | default('', true), true) | default('', true) }}

    - name: Mostrar qué usuario/host se usarán (sin la contraseña)
      debug:
        msg:
          host: "{{ _vc_host }}"
          user: "{{ _vc_user }}"
          user_domain_hint: "{{ (_vc_user.split('@') | length > 1) | ternary(_vc_user.split('@')[-1], 'SIN_DOMINIO') }}"

    - name: Validar que tenemos datos
      assert:
        that:
          - _vc_host | length > 0
          - _vc_user | length > 0
          - _vc_pass | length > 0
        fail_msg: "Faltan host/usuario/clave. Revisa group_vars, vault.yml o variables de entorno."

  tasks:
    - name: Probar conexión con vmware_about_info
      community.vmware.vmware_about_info:
        hostname: "{{ _vc_host }}"
        username: "{{ _vc_user }}"
        password: "{{ _vc_pass }}"
        validate_certs: "{{ vcenter_validate_certs | default(false) }}"
        port: 443
      register: vc_info

    - name: Imprimir claves del resultado (para ver estructura)
      debug:
        msg:
          keys: "{{ vc_info.keys() | list }}"

    - name: Mostrar about_info (versión vCenter/ESXi) si existe
      debug:
        var: vc_info.about_info
      when: vc_info.about_info is defined