---
- name: Crear VMs de infraestructura en vCenter desde PV-INFRA-IaC
  hosts: localhost
  gather_facts: false
  become: false

  collections:
    - community.vmware

  vars:
    # Datos de vCenter (hostname/user/pass vienen del vault)
    vcenter_datacenter: "POPULAR_VALORES"
    vcenter_cluster: "PV-CLUSTER"

    # Nombre de la carpeta de VMs dentro del datacenter
    # Asegúrate de que exista la carpeta PV_IaC en el cliente vSphere
    vcenter_folder: "PV_IaC"

    vcenter_datastore: "PURESTORAGE_PV_X20R4_VOL_1"

    # Nombre del portgroup / red donde estarán las VMs (VLAN-5)
    vcenter_network: "VLAN-5"

    # Usaremos la VM existente PV-INFRA-IaC como "plantilla base" para clonar
    ubuntu_template: "PV-INFRA-IaC"

    # Configuración de red (ajusta gateway / DNS a tu entorno)
    vm_netmask: "255.255.255.0"
    vm_gateway: "192.168.5.1"
    vm_dns_servers:
      - "192.168.5.1"

    # Definición de las VMs a crear (por ahora usamos SOLO nombre e IP;
    # los valores de cpu/memory/disk_gb son informativos para futuras tareas)
    ubuntu_infra_vms:
      - name: "pv-infra-master"
        cpu: 3
        memory_mb: 24576        # 24 GB RAM (para futuro ajuste)
        disk_gb: 140
        ip: "192.168.5.85"
      - name: "pv-infra-nodo1"
        cpu: 2
        memory_mb: 16384        # 16 GB RAM
        disk_gb: 140
        ip: "192.168.5.86"
      - name: "pv-infra-nodo2"
        cpu: 2
        memory_mb: 16384        # 16 GB RAM
        disk_gb: 140
        ip: "192.168.5.87"

  tasks:

    - name: Crear/actualizar VMs de infraestructura desde PV-INFRA-IaC
      community.vmware.vmware_guest:
        hostname: "{{ vcenter_hostname }}"
        username: "{{ vcenter_username }}"
        password: "{{ vcenter_password }}"
        validate_certs: false

        datacenter: "{{ vcenter_datacenter }}"
        cluster: "{{ vcenter_cluster }}"
        folder: "{{ vcenter_folder }}"

        name: "{{ item.name }}"
        template: "{{ ubuntu_template }}"     # clonar desde la VM PV-INFRA-IaC
        state: poweredon

        # IMPORTANTE:
        # No definimos 'hardware' ni 'disk' para no cambiar CPU/RAM/disco
        # durante el clonado (evita errores de hot-add y shrink de disco).

        # Configuración de red + IP estática en VLAN-5
        networks:
          - name: "{{ vcenter_network }}"
            start_connected: true
            type: static
            ip: "{{ item.ip }}"
            netmask: "{{ vm_netmask }}"
            gateway: "{{ vm_gateway }}"
            dns_servers: "{{ vm_dns_servers }}"

        # Customization para hostname/dominio/DNS
        customization:
          hostname: "{{ item.name }}"
          domain: "pv.lab.local"
          dns_servers: "{{ vm_dns_servers }}"

        wait_for_ip_address: no
      loop: "{{ ubuntu_infra_vms }}"
      loop_control:
        label: "{{ item.name }}"
      delegate_to: localhost

    - name: Mostrar resumen de VMs creadas
      debug:
        msg: >
          VM {{ item.name }} clonada desde {{ ubuntu_template }} en carpeta {{ vcenter_folder }},
          datastore {{ vcenter_datastore }}, IP {{ item.ip }} en {{ vcenter_network }}.
      loop: "{{ ubuntu_infra_vms }}"
      loop_control:
        label: "{{ item.name }}"