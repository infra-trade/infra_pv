---
- name: Crear VMs de infraestructura en vCenter desde PV-INFRA-IaC
  hosts: localhost
  gather_facts: false
  become: false

  collections:
    - community.vmware

  vars:
    # Datos de vCenter (hostname/user/pass vienen del vault)
    vcenter_datacenter: "POPULAR_VALORES"
    vcenter_cluster: "PV-CLUSTER"

    # Carpeta de VMs dentro del datacenter (debe existir)
    vcenter_folder: "PV_IaC"

    vcenter_datastore: "PURESTORAGE_PV_X20R4_VOL_1"

    # Portgroup / red donde estarán las VMs (VLAN-5)
    vcenter_network: "VLAN-5"

    # VM base desde la cual clonamos (no es plantilla formal, pero sirve)
    ubuntu_template: "PV-INFRA-IaC"

    # Red (ajusta gateway / DNS si aplica)
    vm_netmask: "255.255.255.0"
    vm_gateway: "192.168.10.2"
    vm_dns_servers:
      - "192.168.10.2"

    # Definición de las VMs a crear
    ubuntu_infra_vms:
      - name: "pv-infra-master"
        cpu: 3
        memory_mb: 24576        # 24 GB RAM (para futuros ajustes)
        disk_gb: 140
        ip: "192.168.5.85"
      - name: "pv-infra-nodo1"
        cpu: 2
        memory_mb: 16384        # 16 GB RAM
        disk_gb: 140
        ip: "192.168.5.86"
      - name: "pv-infra-nodo2"
        cpu: 2
        memory_mb: 16384        # 16 GB RAM
        disk_gb: 140
        ip: "192.168.5.87"

  tasks:

    - name: Crear/actualizar VMs de infraestructura desde PV-INFRA-IaC
      community.vmware.vmware_guest:
        hostname: "{{ vcenter_hostname }}"
        username: "{{ vcenter_username }}"
        password: "{{ vcenter_password }}"
        validate_certs: false

        datacenter: "{{ vcenter_datacenter }}"
        cluster: "{{ vcenter_cluster }}"
        folder: "{{ vcenter_folder }}"

        name: "{{ item.name }}"
        template: "{{ ubuntu_template }}"     # clonar desde la VM PV-INFRA-IaC
        state: poweredon

        # No tocamos hardware ni disco para evitar errores de hot-add / shrink.

        # Configuración de red + IP estática en VLAN-5
        networks:
          - name: "{{ vcenter_network }}"
            start_connected: true
            type: static
            ip: "{{ item.ip }}"
            netmask: "{{ vm_netmask }}"
            gateway: "{{ vm_gateway }}"
            dns_servers: "{{ vm_dns_servers }}"

        # Customization para hostname/dominio/DNS
        customization:
          hostname: "{{ item.name }}"
          domain: "popvalores.local"
          dns_servers: "{{ vm_dns_servers }}"

        wait_for_ip_address: no
      loop: "{{ ubuntu_infra_vms }}"
      loop_control:
        label: "{{ item.name }}"
      delegate_to: localhost

    - name: Registrar hosts clonados en inventario en memoria
      add_host:
        name: "{{ item.name }}"
        ansible_host: "{{ item.ip }}"
        groups: pv_infra_temp
      loop: "{{ ubuntu_infra_vms }}"
      loop_control:
        label: "{{ item.name }}"

    - name: Mostrar resumen de VMs clonadas
      debug:
        msg: >
          VM {{ item.name }} clonada desde {{ ubuntu_template }} en carpeta {{ vcenter_folder }},
          datastore {{ vcenter_datastore }}, IP {{ item.ip }} en {{ vcenter_network }}.
      loop: "{{ ubuntu_infra_vms }}"
      loop_control:
        label: "{{ item.name }}"

# ======================================================================
# Segundo play: instalar la llave SSH del nodo Ansible en las VMs nuevas
# ======================================================================
- name: Instalar llave SSH del nodo PV-INFRA-IaC en VMs clonadas
  hosts: pv_infra_temp
  gather_facts: false
  become: true

  vars:
    # Usuario remoto (el que usas para entrar a las VMs; ajusta si no es pvinfra)
    ssh_user: "{{ ansible_user | default(ansible_ssh_user) | default('pvinfra') }}"
    # Leemos la llave pública del controlador (PV-INFRA-IaC)
    ssh_public_key: "{{ lookup('file', lookup('env','HOME') + '/.ssh/id_ed25519.pub') }}"

  tasks:
    - name: Crear carpeta .ssh si no existe
      ansible.builtin.file:
        path: "/home/{{ ssh_user }}/.ssh"
        state: directory
        owner: "{{ ssh_user }}"
        group: "{{ ssh_user }}"
        mode: "0700"

    - name: Autorizar llave pública del nodo Ansible
      ansible.builtin.authorized_key:
        user: "{{ ssh_user }}"
        state: present
        key: "{{ ssh_public_key }}"