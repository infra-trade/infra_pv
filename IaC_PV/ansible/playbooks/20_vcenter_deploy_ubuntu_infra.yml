---
- name: Crear VMs de infraestructura en vCenter desde PV-INFRA-IaC
  hosts: localhost
  gather_facts: false

  vars_files:
    # Variables de conexión a vCenter (vault)
    - "../inventories/vcenter/group_vars/all/vcenter.yml"

  vars:
    infra_vms:
      - name: pv-infra-master
        ip: "192.168.5.85"
        cpu: 3
        memory_mb: 24576   # 24 GB
        disk_gb: 140
      - name: pv-infra-nodo1
        ip: "192.168.5.86"
        cpu: 2
        memory_mb: 16384   # 16 GB
        disk_gb: 140
      - name: pv-infra-nodo2
        ip: "192.168.5.87"
        cpu: 2
        memory_mb: 16384   # 16 GB
        disk_gb: 140

    # Parámetros del template y entorno vSphere
    vm_source_name: "PV-INFRA-IaC"                    # Nombre del template origen
    vm_folder: "PV_IaC"                               # Carpeta en vCenter
    vm_datastore: "PURESTORAGE_PV_X20R4_VOL_1"        # Datastore donde se crean las VMs
    vm_network: "VLAN-5"                              # Portgroup / red
    vm_netmask: "255.255.255.0"
    vm_gateway: "192.168.5.252"
    vm_dns_servers:
      - "192.168.10.2"
      - "8.8.8.8"

  tasks:

    - name: Crear/actualizar VMs de infraestructura (con hardware) DEJÁNDOLAS APAGADAS
      community.vmware.vmware_guest:
        hostname: "{{ vcenter_hostname }}"
        username: "{{ vcenter_username }}"
        password: "{{ vcenter_password }}"
        validate_certs: "{{ vcenter_validate_certs | default(false) }}"
        datacenter: "{{ vcenter_datacenter }}"
        cluster: "{{ vcenter_cluster }}"
        folder: "{{ vm_folder }}"
        name: "{{ item.name }}"
        state: poweredoff           # Primero las dejamos apagadas
        template: "{{ vm_source_name }}"
        datastore: "{{ vm_datastore }}"
        hardware:
          memory_mb: "{{ item.memory_mb }}"
          num_cpus: "{{ item.cpu }}"
        networks:
          - name: "{{ vm_network }}"
            type: static
            ip: "{{ item.ip }}"
            netmask: "{{ vm_netmask }}"
            gateway: "{{ vm_gateway }}"
            dns_servers: "{{ vm_dns_servers }}"
        wait_for_ip_address: false
      loop: "{{ infra_vms }}"
      delegate_to: localhost

    - name: Encender VMs de infraestructura
      community.vmware.vmware_guest:
        hostname: "{{ vcenter_hostname }}"
        username: "{{ vcenter_username }}"
        password: "{{ vcenter_password }}"
        validate_certs: "{{ vcenter_validate_certs | default(false) }}"
        datacenter: "{{ vcenter_datacenter }}"
        cluster: "{{ vcenter_cluster }}"
        folder: "{{ vm_folder }}"
        name: "{{ item.name }}"
        state: poweredon            # Aquí solo encendemos, sin tocar hardware
        wait_for_ip_address: false
      loop: "{{ infra_vms }}"
      delegate_to: localhost

    - name: Registrar hosts clonados en inventario en memoria
      ansible.builtin.add_host:
        name: "{{ item.name }}"
        groups:
          - pv_infra_temp
        ansible_host: "{{ item.ip }}"
        ansible_user: "pvinfra"
      loop: "{{ infra_vms }}"

    - name: Mostrar resumen de VMs clonadas
      ansible.builtin.debug:
        msg: >-
          VM {{ item.name }} clonada/actualizada desde {{ vm_source_name }}
          en carpeta {{ vm_folder }}, datastore {{ vm_datastore }},
          IP {{ item.ip }} en {{ vm_network }}.
      loop: "{{ infra_vms }}"

# ======================================================================
# Segundo play: instalar llave SSH y sudo sin contraseña en las VMs
# ======================================================================
- name: Instalar llave SSH del nodo PV-INFRA-IaC en VMs clonadas
  hosts: pv_infra_temp
  gather_facts: false
  remote_user: "pvinfra"
  become: true
  serial: 1

  vars:
    ssh_public_key: "{{ lookup('file', lookup('env','HOME') + '/.ssh/id_ed25519.pub') }}"

  tasks:
    - name: Esperar a que SSH (puerto 22) esté disponible
      ansible.builtin.wait_for:
        host: "{{ ansible_host | default(inventory_hostname) }}"
        port: 22
        delay: 10
        timeout: 600
        state: started
      delegate_to: localhost

    - name: Crear carpeta .ssh si no existe
      ansible.builtin.file:
        path: "/home/pvinfra/.ssh"
        state: directory
        owner: "pvinfra"
        group: "pvinfra"
        mode: "0700"

    - name: Autorizar llave pública del nodo Ansible
      ansible.posix.authorized_key:
        user: "pvinfra"
        state: present
        key: "{{ ssh_public_key }}"

    - name: Asegurar que el usuario pvinfra está en el grupo sudo
      ansible.builtin.user:
        name: "pvinfra"
        groups: "sudo"
        append: true

    - name: Permitir sudo sin contraseña para pvinfra
      ansible.builtin.copy:
        dest: /etc/sudoers.d/99-pvinfra-nopasswd
        content: "pvinfra ALL=(ALL) NOPASSWD:ALL\n"
        owner: root
        group: root
        mode: "0440"
        validate: "visudo -cf %s"