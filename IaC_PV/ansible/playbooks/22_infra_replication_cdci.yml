---
- name: 22 - Replicar docker-compose desde IaC_PV hacia nodos infra (CD/CI simple)
  hosts: docker_hosts
  become: true

  vars:
    # Mapear rol por IP (NO por nombre)
    infra_role_by_ip:
      "192.168.5.85": "master"
      "192.168.5.86": "noc"
      "192.168.5.87": "soc"

    # Carpeta base en cada VM donde montaremos los stacks
    base_remote_dir: "/opt/stacks"

  tasks:
    - name: Determinar rol de este host segÃºn su IP
      ansible.builtin.set_fact:
        infra_role: "{{ infra_role_by_ip[ansible_host] | default('master') }}"

    - name: Mostrar rol detectado para este host
      ansible.builtin.debug:
        msg: "Host {{ inventory_hostname }} ({{ ansible_host }}) => rol {{ infra_role }}"

    # ------------------------------------------------------------------
    # Crear estructura de carpetas en cada VM
    # ------------------------------------------------------------------
    - name: Crear directorio base para stacks
      ansible.builtin.file:
        path: "{{ base_remote_dir }}"
        state: directory
        owner: root
        group: root
        mode: "0755"

    - name: Crear subdirectorios master, noc y soc en cada VM
      ansible.builtin.file:
        path: "{{ base_remote_dir }}/{{ item }}"
        state: directory
        owner: root
        group: root
        mode: "0755"
      loop:
        - master
        - noc
        - soc

    # ------------------------------------------------------------------
    # Replicar docker-compose desde el repo local al host remoto
    # ------------------------------------------------------------------
    - name: Definir ruta local del docker-compose a replicar para este rol
      ansible.builtin.set_fact:
        local_compose_path: "{{ playbook_dir | dirname | dirname }}/replication/{{ infra_role }}/docker-compose.yml"

    - name: Comprobar que existe el docker-compose local para este rol
      ansible.builtin.stat:
        path: "{{ local_compose_path }}"
      register: compose_stat
      delegate_to: localhost
      run_once: false

    - name: Fallar si no existe el docker-compose local para este rol
      ansible.builtin.fail:
        msg: "No existe {{ local_compose_path }} en el nodo de Ansible para rol {{ infra_role }}."
      when: not compose_stat.stat.exists
      delegate_to: localhost
      run_once: false

    - name: Copiar docker-compose.yml correspondiente al rol
      ansible.builtin.copy:
        src: "{{ local_compose_path }}"
        dest: "{{ base_remote_dir }}/{{ infra_role }}/docker-compose.yml"
        owner: root
        group: root
        mode: "0644"

    # ------------------------------------------------------------------
    # Desplegar / actualizar stack con docker compose
    # ------------------------------------------------------------------
    - name: Levantar stack con docker compose (pull + up -d)
      ansible.builtin.shell: |
        set -e
        cd "{{ base_remote_dir }}/{{ infra_role }}"
        docker compose pull
        docker compose up -d
      args:
        executable: /bin/bash