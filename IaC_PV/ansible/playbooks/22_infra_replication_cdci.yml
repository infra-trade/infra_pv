---
- name: 22 - Replicar docker-compose desde IaC_PV hacia nodos infra (CD/CI simple)
  hosts: pv-infra-master, pv-infra-noc, pv-infra-soc
  become: true
  gather_facts: true

  vars:
    # Directorio base en cada VM donde se montan los stacks
    stacks_base_dir: "/opt/stacks"

    # Rutas locales (en la VM de Ansible: PV-INFRA-IaC) de los docker-compose por rol
    local_compose_src_master: "/home/pvinfra/infra_pv/IaC_PV/replication/master/docker-compose.yml"
    local_compose_src_noc:    "/home/pvinfra/infra_pv/IaC_PV/replication/noc/docker-compose.yml"
    local_compose_src_soc:    "/home/pvinfra/infra_pv/IaC_PV/replication/soc/docker-compose.yml"

    # Mapeo IP -> rol
    role_by_ip:
      "192.168.5.85": "master"
      "192.168.5.86": "noc"
      "192.168.5.87": "soc"

  tasks:
    # ------------------------------------------------------------------
    # 1) Determinar rol de cada host según su IP
    # ------------------------------------------------------------------
    - name: Determinar rol de este host según su IP
    #  ansible_default_ipv4.address suele devolver la IP principal
      ansible.builtin.set_fact:
        infra_role: "{{ role_by_ip[ansible_default_ipv4.address] | default('noc') }}"

    - name: Mostrar rol detectado para este host
      ansible.builtin.debug:
        msg: "Host {{ inventory_hostname }} ({{ ansible_default_ipv4.address }}) => rol {{ infra_role }}"

    # ------------------------------------------------------------------
    # 2) Crear estructura de directorios en CADA VM:
    #    /opt/stacks/{master,noc,soc}
    # ------------------------------------------------------------------
    - name: Crear directorio base para stacks
      ansible.builtin.file:
        path: "{{ stacks_base_dir }}"
        state: directory
        owner: root
        group: root
        mode: "0755"

    - name: Crear subdirectorios master, noc y soc en cada VM
      ansible.builtin.file:
        path: "{{ stacks_base_dir }}/{{ item }}"
        state: directory
        owner: root
        group: root
        mode: "0755"
      loop:
        - master
        - noc
        - soc

    # ------------------------------------------------------------------
    # 3) Resolver qué docker-compose local corresponde según el rol
    # ------------------------------------------------------------------
    - name: Definir ruta local del docker-compose a replicar para este rol
      ansible.builtin.set_fact:
        local_compose_src: >-
          {{
            (infra_role == 'master') | ternary(local_compose_src_master,
            (infra_role == 'noc')    | ternary(local_compose_src_noc,
                                              local_compose_src_soc))
          }}

    # ------------------------------------------------------------------
    # 4) Comprobar en la MÁQUINA DE ANSIBLE (localhost) que existe
    #    el docker-compose correspondiente al rol
    #    IMPORTANTE: SIN sudo (become: false) -> NO pide clave
    # ------------------------------------------------------------------
    - name: Comprobar que existe el docker-compose local para este rol
      ansible.builtin.stat:
        path: "{{ local_compose_src }}"
      register: local_compose_stat
      delegate_to: localhost
      become: false

    - name: Fallar si no existe el docker-compose local para este rol
      ansible.builtin.fail:
        msg: "No existe el archivo {{ local_compose_src }} en la máquina de Ansible (PV-INFRA-IaC)"
      when: not local_compose_stat.stat.exists
      delegate_to: localhost
      become: false

    # ------------------------------------------------------------------
    # 5) Copiar docker-compose al host remoto, en su carpeta según rol
    # ------------------------------------------------------------------
    - name: Copiar docker-compose.yml correspondiente al rol
      ansible.builtin.copy:
        src: "{{ local_compose_src }}"
        dest: "{{ stacks_base_dir }}/{{ infra_role }}/docker-compose.yml"
        owner: root
        group: root
        mode: "0644"

    # ------------------------------------------------------------------
    # 6) Levantar stack con docker compose (pull + up -d)
    #    Usa el plugin moderno: `docker compose`
    #    (que instalamos en el play 21 con docker-compose-plugin)
    # ------------------------------------------------------------------
    - name: Levantar stack con docker compose (pull + up -d)
      ansible.builtin.shell: |
        set -e
        cd "{{ stacks_base_dir }}/{{ infra_role }}"
        docker compose pull
        docker compose up -d
      args:
        executable: /bin/bash