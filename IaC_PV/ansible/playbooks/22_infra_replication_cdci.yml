---
- name: 22 - Replicar docker-compose desde IaC_PV hacia nodos infra (CD/CI simple)
  hosts: docker_hosts
  become: true

  # ===========================
  # PRE-TAREAS: GIT PULL
  # ===========================
  pre_tasks:
    - name: Actualizar repo IaC_PV desde Git (git pull en el nodo Ansible)
      ansible.builtin.git:
        repo: "https://github.com/TU_USUARIO/TU_REPO.git"   # <-- AJUSTA ESTO
        dest: "{{ playbook_dir | dirname | dirname }}"      # /home/pvinfra/infra_pv/IaC_PV
        version: main                                       # rama a usar (main/master)
        update: yes
      delegate_to: localhost
      run_once: true
      become: false

  vars:
    # Mapear rol por IP (NO por nombre)
    infra_role_by_ip:
      "192.168.5.85": "master"
      "192.168.5.86": "noc"
      "192.168.5.87": "soc"

    # Carpeta base en cada VM donde montaremos los stacks
    base_remote_dir: "/opt/stacks"

  tasks:
    - name: Determinar rol de este host según su IP
      ansible.builtin.set_fact:
        infra_role: "{{ infra_role_by_ip[ansible_host] | default('master') }}"

    - name: Mostrar rol detectado para este host
      ansible.builtin.debug:
        msg: "Host {{ inventory_hostname }} ({{ ansible_host }}) => rol {{ infra_role }}"

    # ------------------------------------------------------------------
    # Crear estructura de carpetas en cada VM
    # ------------------------------------------------------------------
    - name: Crear directorio base para stacks
      ansible.builtin.file:
        path: "{{ base_remote_dir }}"
        state: directory
        owner: root
        group: root
        mode: "0755"

    - name: Crear subdirectorios master, noc y soc en cada VM
      ansible.builtin.file:
        path: "{{ base_remote_dir }}/{{ item }}"
        state: directory
        owner: root
        group: root
        mode: "0755"
      loop:
        - master
        - noc
        - soc

    # ------------------------------------------------------------------
    # Replicar docker-compose desde el repo local al host remoto
    # ------------------------------------------------------------------
    - name: Definir ruta local del docker-compose a replicar para este rol
      ansible.builtin.set_fact:
        local_compose_path: "{{ playbook_dir | dirname | dirname }}/replication/{{ infra_role }}/docker-compose.yml"

    - name: Comprobar que existe el docker-compose local para este rol
      ansible.builtin.stat:
        path: "{{ local_compose_path }}"
      register: compose_stat
      delegate_to: localhost
      run_once: false

    - name: Fallar si no existe el docker-compose local para este rol
      ansible.builtin.fail:
        msg: "No existe {{ local_compose_path }} en el nodo de Ansible para rol {{ infra_role }}."
      when: not compose_stat.stat.exists
      delegate_to: localhost
      run_once: false

    - name: Copiar docker-compose.yml correspondiente al rol
      ansible.builtin.copy:
        src: "{{ local_compose_path }}"
        dest: "{{ base_remote_dir }}/{{ infra_role }}/docker-compose.yml"
        owner: root
        group: root
        mode: "0644"

    # ------------------------------------------------------------------
    # Detectar comando docker compose disponible
    # ------------------------------------------------------------------
    - name: Detectar si 'docker compose' (plugin v2) está disponible
      ansible.builtin.command: docker compose version
      register: docker_compose_v2
      changed_when: false
      failed_when: false

    - name: Detectar si 'docker-compose' (binario v1) está disponible
      ansible.builtin.command: docker-compose --version
      register: docker_compose_v1
      changed_when: false
      failed_when: false

    - name: Definir comando base para docker compose
      ansible.builtin.set_fact:
        docker_compose_cmd: >-
          {{ 'docker compose'
             if docker_compose_v2.rc == 0
             else ('docker-compose'
                   if docker_compose_v1.rc == 0
                   else 'docker compose') }}

    - name: Fallar si no hay ningún comando docker compose disponible
      ansible.builtin.fail:
        msg: >-
          No se encontró ni 'docker compose' ni 'docker-compose' en {{ inventory_hostname }}.
          Instala el plugin docker-compose (docker-compose-plugin) o el paquete docker-compose.
      when: docker_compose_v2.rc != 0 and docker_compose_v1.rc != 0

    # ------------------------------------------------------------------
    # Desplegar / actualizar stack con docker compose
    # ------------------------------------------------------------------
    - name: Levantar stack con docker compose (pull + up -d)
      ansible.builtin.shell: |
        set -e
        cd "{{ base_remote_dir }}/{{ infra_role }}"
        {{ docker_compose_cmd }} pull
        {{ docker_compose_cmd }} up -d
      args:
        executable: /bin/bash
      when: docker_compose_v2.rc == 0 or docker_compose_v1.rc == 0