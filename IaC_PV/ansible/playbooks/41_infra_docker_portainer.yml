---
- name: "21v2 - Docker Engine + Compose v2 + hardening bÃ¡sico"
  hosts: docker_hosts
  become: true

  vars:
    docker_users: ["pvinfra"]
    docker_daemon_json:
      log-driver: "json-file"
      log-opts:
        max-size: "10m"
        max-file: "3"
      storage-driver: "overlay2"
      live-restore: true

  tasks:
    - name: "APT update"
      ansible.builtin.apt:
        update_cache: true
        cache_valid_time: 3600

    - name: "Deps"
      ansible.builtin.apt:
        name:
          - ca-certificates
          - curl
          - gnupg
          - lsb-release
        state: present

    - name: "Crear keyring dir"
      ansible.builtin.file:
        path: /etc/apt/keyrings
        state: directory
        mode: "0755"

    - name: "Docker GPG key"
      ansible.builtin.shell: |
        set -e
        if [ ! -f /etc/apt/keyrings/docker.gpg ]; then
          curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /etc/apt/keyrings/docker.gpg
          chmod a+r /etc/apt/keyrings/docker.gpg
        fi
      args: { executable: /bin/bash }
      changed_when: false

    - name: "Docker repo"
      ansible.builtin.shell: |
        set -e
        arch="$(dpkg --print-architecture)"
        codename="$(. /etc/os-release && echo $VERSION_CODENAME)"
        echo "deb [arch=${arch} signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu ${codename} stable" \
          > /etc/apt/sources.list.d/docker.list
      args: { executable: /bin/bash }
      changed_when: false

    - name: "APT update (con repo Docker)"
      ansible.builtin.apt:
        update_cache: true

    - name: "Instalar Docker Engine + Compose v2"
      ansible.builtin.apt:
        name:
          - docker-ce
          - docker-ce-cli
          - containerd.io
          - docker-buildx-plugin
          - docker-compose-plugin
        state: present

    - name: "Config daemon.json"
      ansible.builtin.copy:
        dest: /etc/docker/daemon.json
        content: "{{ docker_daemon_json | to_nice_json }}"
        owner: root
        group: root
        mode: "0644"
      notify: restart_docker

    - name: "Asegurar grupo docker"
      ansible.builtin.group:
        name: docker
        state: present

    - name: "Agregar usuarios a docker group"
      ansible.builtin.user:
        name: "{{ item }}"
        groups: docker
        append: true
      loop: "{{ docker_users }}"

    - name: "Enable/start Docker"
      ansible.builtin.systemd:
        name: docker
        state: started
        enabled: true

    - name: "Verificar compose v2"
      ansible.builtin.command: docker compose version
      register: compose_v2
      changed_when: false
      failed_when: false

    - name: "Debug compose"
      ansible.builtin.debug:
        msg: "compose => {{ compose_v2.stdout | default('no disponible') }}"

  handlers:
    - name: restart_docker
      ansible.builtin.systemd:
        name: docker
        state: restarted

# ----------------------------------------------------------------------

- name: "21v2 - Portainer Server (en pv-infra-master) con compose"
  hosts: portainer_server
  become: true

  vars:
    portainer_base: /opt/stacks/master/portainer
    portainer_compose: "{{ portainer_base }}/docker-compose.yml"
    portainer_reset: false

    portainer_image: "portainer/portainer-ce:2.20.3"
    portainer_volume: "portainer_data"
    portainer_name: "portainer"

  tasks:
    - name: "Crear base"
      ansible.builtin.file:
        path: "{{ portainer_base }}"
        state: directory
        mode: "0755"

    - name: "Reset opcional (contenedor + volumen)"
      ansible.builtin.shell: |
        set -e
        docker rm -f {{ portainer_name }} >/dev/null 2>&1 || true
        docker volume rm {{ portainer_volume }} >/dev/null 2>&1 || true
      args: { executable: /bin/bash }
      when: portainer_reset

    - name: "Escribir compose Portainer"
      ansible.builtin.copy:
        dest: "{{ portainer_compose }}"
        mode: "0644"
        content: |
          version: "3.8"
          services:
            portainer:
              image: {{ portainer_image }}
              container_name: {{ portainer_name }}
              restart: unless-stopped
              ports:
                - "9443:9443"
              volumes:
                - /var/run/docker.sock:/var/run/docker.sock
                - {{ portainer_volume }}:/data
              healthcheck:
                test: ["CMD-SHELL", "wget -qO- https://localhost:9443 || exit 1"]
                interval: 30s
                timeout: 10s
                retries: 5
          volumes:
            {{ portainer_volume }}:

    - name: "Up Portainer"
      ansible.builtin.command:
        cmd: "docker compose -f {{ portainer_compose }} up -d"
      args:
        chdir: "{{ portainer_base }}"

# ----------------------------------------------------------------------

- name: "21v2 - Portainer Agent (en nodos) con compose"
  hosts: portainer_agents
  become: true

  vars:
    agent_base: /opt/stacks/agent/portainer
    agent_compose: "{{ agent_base }}/docker-compose.yml"
    agent_reset: false

    agent_image: "portainer/agent:2.20.3"
    agent_name: "portainer_agent"

  tasks:
    - name: "Crear base"
      ansible.builtin.file:
        path: "{{ agent_base }}"
        state: directory
        mode: "0755"

    - name: "Reset opcional contenedor"
      ansible.builtin.shell: |
        set -e
        docker rm -f {{ agent_name }} >/dev/null 2>&1 || true
      args: { executable: /bin/bash }
      when: agent_reset

    - name: "Escribir compose Agent"
      ansible.builtin.copy:
        dest: "{{ agent_compose }}"
        mode: "0644"
        content: |
          version: "3.8"
          services:
            agent:
              image: {{ agent_image }}
              container_name: {{ agent_name }}
              restart: unless-stopped
              ports:
                - "9001:9001"
              volumes:
                - /var/run/docker.sock:/var/run/docker.sock
                - /var/lib/docker/volumes:/var/lib/docker/volumes
              environment:
                - LOG_LEVEL=INFO

    - name: "Up Agent"
      ansible.builtin.command:
        cmd: "docker compose -f {{ agent_compose }} up -d"
      args:
        chdir: "{{ agent_base }}"