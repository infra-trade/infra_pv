---
- name: Construir ISO seed para autoinstall ubuntu-seed-24-04
  hosts: localhost
  gather_facts: false

  vars:
    # Evita recursiones: nunca referenciar datastore_iso_dir sobre sí mismo aquí
    iso_dir_default: "ISOS"
    seed_workdir: "/tmp/seed-{{ seed_vm_name }}"
    seed_iso_local: "/tmp/{{ seed_iso_filename }}"
    # Si necesitas subir a vSphere, compón la ruta destino
    seed_iso_vsphere_path: "[{{ vcenter_datastore }}] {{ datastore_iso_dir | default(iso_dir_default) }}/{{ seed_iso_filename }}"

  pre_tasks:
    - name: Verificar existencia de vault.yml
      ansible.builtin.stat:
        path: "{{ playbook_dir }}/../vault.yml"
      register: _vault

    - name: Cargar vault.yml si existe
      ansible.builtin.include_vars:
        file: "{{ playbook_dir }}/../vault.yml"
      when: _vault.stat.exists
      no_log: true

    - name: Leer clave pública SSH
      ansible.builtin.slurp:
        src: "{{ ssh_pubkey_path }}"
      register: _ssh_key

    - name: Decodificar clave pública SSH
      ansible.builtin.set_fact:
        ssh_pubkey: "{{ _ssh_key.content | b64decode | trim }}"

    - name: Limpiar directorio local seed
      ansible.builtin.file:
        path: "{{ seed_workdir }}"
        state: absent
      become: true
      become_method: community.general.doas

    - name: Crear directorio local seed
      ansible.builtin.file:
        path: "{{ seed_workdir }}"
        state: directory
        mode: "0755"
      become: true
      become_method: community.general.doas

    - name: Crear meta-data
      ansible.builtin.copy:
        dest: "{{ seed_workdir }}/meta-data"
        mode: "0644"
        content: |
          instance-id: {{ seed_vm_name }}
          local-hostname: {{ seed_vm_name }}
      become: true
      become_method: community.general.doas

    - name: Crear user-data (autoinstall)
      ansible.builtin.copy:
        dest: "{{ seed_workdir }}/user-data"
        mode: "0644"
        content: |
          #cloud-config
          autoinstall:
            version: 1
            locale: en_US.UTF-8
            keyboard:
              layout: us
            identity:
              hostname: {{ seed_vm_name }}
              username: {{ linux_user }}
              # Puedes dejar lock_passwd true y usar SOLO llaves SSH si prefieres
              # password: "<HASH_SHA512_OPCIONAL>"
            ssh:
              install-server: true
              authorized-keys:
                - {{ ssh_pubkey }}
            user-data:
              disable_root: true
              timezone: Etc/UTC
              package_update: true
              package_upgrade: true
              users:
                - name: {{ linux_user }}
                  lock_passwd: true
                  shell: /bin/bash
                  sudo: ALL=(ALL) NOPASSWD:ALL
                  ssh_authorized_keys:
                    - {{ ssh_pubkey }}
            packages:
              - openssh-server
              - open-vm-tools
              - cloud-init
            storage:
              layout:
                name: lvm
            late-commands:
              - curtin in-target -- sh -c "install -D -m 0440 /dev/stdin /etc/sudoers.d/90-ansible << 'EOF'
          Defaults:{{ linux_user }} !requiretty
          {{ linux_user }} ALL=(ALL) NOPASSWD:ALL
          EOF
          visudo -cf /etc/sudoers.d/90-ansible"
              - curtin in-target -- cloud-init clean --logs || true
              - curtin in-target -- systemctl enable open-vm-tools || true
      become: true
      become_method: community.general.doas

    - name: Detectar comando para crear ISO (genisoimage o mkisofs)
      ansible.builtin.shell: |
        set -e
        if command -v genisoimage >/dev/null 2>&1; then
          echo genisoimage
        elif command -v mkisofs >/dev/null 2>&1; then
          echo mkisofs
        else
          exit 3
        fi
      register: _iso_tool
      changed_when: false
      failed_when: _iso_tool.rc not in [0]

    - name: Fallar si no hay herramienta para crear ISO
      ansible.builtin.fail:
        msg: "No se encontró genisoimage/mkisofs. Instala cdrkit/cdrtools."
      when: _iso_tool.stdout | trim == ""

    - name: Crear ISO seed local con etiqueta cidata
      ansible.builtin.shell: |
        cd "{{ seed_workdir }}"
        "{{ _iso_tool.stdout | trim }}" -output "{{ seed_iso_local }}" -volid cidata -joliet -rock meta-data user-data
      args:
        creates: "{{ seed_iso_local }}"
      become: true
      become_method: community.general.doas

    - name: Resolver parámetros de vCenter mínimos
      ansible.builtin.set_fact:
        vc_hostname: "{{ (vcenter_hostname | default('')) or lookup('env','VCENTER_HOST') | default('') }}"
        vc_username: "{{ (vcenter_username | default('')) or lookup('env','VCENTER_USERNAME') | default('') }}"
        vc_password: "{{ (vcenter_password | default('')) or lookup('env','VCENTER_PASSWORD') | default('') }}"
        vc_datacenter: "{{ vcenter_datacenter | default('') }}"
        vc_datastore: "{{ vcenter_datastore | default('') }}"
        vc_port: "{{ (vcenter_port | default(443)) | int }}"
        vc_validate: "{{ vcenter_validate_certs | default(false) | bool }}"

  tasks:
    - name: Validar parámetros de vCenter para subir ISO
      ansible.builtin.assert:
        that:
          - vc_hostname | length > 0
          - vc_username | length > 0
          - vc_password | length > 0
          - vc_datacenter | length > 0
          - vc_datastore | length > 0
        fail_msg: "Faltan parámetros de vCenter (hostname/username/password/datacenter/datastore)."
      when: upload_seed_to_datastore | default(false) | bool

    - name: Subir seed ISO al datastore (opcional)
      community.vmware.vsphere_copy:
        hostname: "{{ vc_hostname }}"
        username: "{{ vc_username }}"
        password: "{{ vc_password }}"
        validate_certs: "{{ vc_validate }}"
        src: "{{ seed_iso_local }}"
        datacenter: "{{ vc_datacenter }}"
        datastore: "{{ vc_datastore }}"
        path: "{{ datastore_iso_dir | default(iso_dir_default) }}/{{ seed_iso_filename }}"
      when: upload_seed_to_datastore | default(false) | bool

    - name: Mostrar resultado local
      ansible.builtin.debug:
        msg:
          seed_iso_local: "{{ seed_iso_local }}"
          seed_iso_vsphere_path: "{{ seed_iso_vsphere_path }}"