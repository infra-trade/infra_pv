---
- name: Construir ISO seed para autoinstall ubuntu-seed-24-04
  hosts: localhost
  gather_facts: false
  become: true

  vars:
    seed_vm_name: "ubuntu-seed-24-04"
    seed_dir: "/tmp/seed-{{ seed_vm_name }}"
    seed_iso_local: "/tmp/seed-{{ seed_vm_name }}.iso"

    # Ajusta si tu pubkey es otra
    ssh_pubkey_path: "/home/ansible/.ssh/id_ed25519.pub"

  pre_tasks:
    - name: Verificar que genisoimage está instalado
      ansible.builtin.command: which genisoimage
      register: geniso_check
      failed_when: geniso_check.rc != 0
      changed_when: false

    - name: Cargar vault.yml (si existe)
      ansible.builtin.stat:
        path: "{{ playbook_dir }}/../vault.yml"
      register: vault_stat

    - name: include vault.yml
      ansible.builtin.include_vars:
        file: "{{ playbook_dir }}/../vault.yml"
      when: vault_stat.stat.exists
      no_log: true

    - name: Leer clave pública SSH
      ansible.builtin.slurp:
        src: "{{ ssh_pubkey_path }}"
      register: pubkey_raw

    - name: Decodificar clave pública SSH
      ansible.builtin.set_fact:
        ssh_pubkey: "{{ pubkey_raw.content | b64decode | trim }}"

  tasks:
    - name: Limpiar directorio local seed
      ansible.builtin.file:
        path: "{{ seed_dir }}"
        state: absent

    - name: Crear directorio local seed
      ansible.builtin.file:
        path: "{{ seed_dir }}"
        state: directory
        owner: root
        group: wheel
        mode: '0755'

    - name: Crear meta-data
      ansible.builtin.copy:
        dest: "{{ seed_dir }}/meta-data"
        mode: '0644'
        content: |
          instance-id: {{ seed_vm_name }}
          local-hostname: {{ seed_vm_name }}

    - name: Crear user-data (autoinstall)
      ansible.builtin.copy:
        dest: "{{ seed_dir }}/user-data"
        mode: '0644'
        content: |
          #cloud-config
          autoinstall:
            version: 1
            identity:
              hostname: {{ seed_vm_name }}
              username: ansible
              # IMPORTANTE: reemplaza por hash real si quieres login por password:
              # password: "$6$xxxx$yyyy"
              password: "$6$rounds=4096$H0LD3R$E7x2U6M7N7jYQfFcSmM0S7FhZzqIVGmF4aX8c/."
            ssh:
              install-server: true
              authorized-keys:
                - "{{ ssh_pubkey }}"
            user-data:
              disable_root: true
              ssh_pwauth: false
            locale: en_US.UTF-8
            keyboard:
              layout: us
            network:
              network:
                version: 2
                ethernets:
                  ens160:
                    dhcp4: true
            storage:
              layout:
                name: direct
            packages:
              - qemu-guest-agent
              - open-vm-tools
            late-commands:
              - curtin in-target --target=/target apt-get update
              - curtin in-target --target=/target apt-get -y install open-vm-tools

    - name: Crear ISO seed local con etiqueta cidata
      ansible.builtin.command:
        cmd: >
          genisoimage -output {{ seed_iso_local }}
          -volid cidata -joliet -rock
          meta-data user-data
        chdir: "{{ seed_dir }}"
      register: geniso_out
      changed_when: true

    - name: Mostrar ruta del ISO seed generado
      ansible.builtin.debug:
        msg: "ISO seed generado en {{ seed_iso_local }}. Súbelo a tu datastore como ISOS/seed-{{ seed_vm_name }}.iso"