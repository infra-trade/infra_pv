---
- name: Construir ISO seed para autoinstall ubuntu-seed-24-04
  hosts: localhost
  gather_facts: false

  vars:
    seed_vm_name_default: "ubuntu-seed-24-04"
    datastore_iso_dir_default: "ISOS"
    ubuntu_iso_filename_default: "ubuntu-24.04.3-live-server-amd64.iso"
    # Rutas probables de genisoimage/mkisofs en *BSD/Linux (sin bash)
    iso_candidates:
      - /usr/local/bin/genisoimage
      - /usr/bin/genisoimage
      - /bin/genisoimage
      - /usr/local/bin/mkisofs
      - /usr/bin/mkisofs
      - /bin/mkisofs

  pre_tasks:
    - name: Cargar vault.yml (password vCenter) si existe
      ansible.builtin.include_vars:
        file: "{{ playbook_dir }}/../vault.yml"
      no_log: true
      when: lookup('ansible.builtin.fileglob', playbook_dir + '/../vault.yml', errors='ignore') | length > 0

    - name: Resolver seed_vm_name (efectivo)
      ansible.builtin.set_fact:
        seed_vm_name_eff: >-
          {{
            (seed_vm_name is defined and seed_vm_name|string|length>0)
            | ternary(seed_vm_name, seed_vm_name_default)
          }}

    - name: Resolver ssh_pubkey_path (ENV > all.yml > default)
      ansible.builtin.set_fact:
        ssh_pubkey_path_eff: >-
          {{
            (lookup('env','SSH_PUBKEY_PATH')
             or (ssh_pubkey_path | default('~/.ssh/id_ed25519.pub')))
            | expanduser
          }}

    - name: Verificar existencia de clave pública SSH
      ansible.builtin.stat:
        path: "{{ ssh_pubkey_path_eff }}"
      register: _pubkey_stat

    - name: Fallar si no existe la clave pública
      ansible.builtin.fail:
        msg: "No existe la clave pública en {{ ssh_pubkey_path_eff }}. Define ssh_pubkey_path o exporta SSH_PUBKEY_PATH."
      when: not _pubkey_stat.stat.exists

    - name: Resolver rutas locales (efectivas)
      ansible.builtin.set_fact:
        seed_local_dir: "/tmp/seed-{{ seed_vm_name_eff }}"
        seed_local_iso: "/tmp/seed-{{ seed_vm_name_eff }}.iso"

  tasks:
    # ---------- Construcción ISO seed ----------
    - name: Leer clave pública SSH
      ansible.builtin.slurp:
        src: "{{ ssh_pubkey_path_eff }}"
      register: _pubkey_raw

    - name: Decodificar clave pública SSH
      ansible.builtin.set_fact:
        ssh_pubkey: "{{ _pubkey_raw.content | b64decode | trim }}"

    - name: Limpiar directorio local seed
      ansible.builtin.file:
        path: "{{ seed_local_dir }}"
        state: absent

    - name: Crear directorio local seed
      ansible.builtin.file:
        path: "{{ seed_local_dir }}"
        state: directory
        mode: "0755"

    - name: Crear meta-data
      ansible.builtin.copy:
        dest: "{{ seed_local_dir }}/meta-data"
        mode: "0644"
        content: |
          instance-id: {{ seed_vm_name_eff }}
          local-hostname: {{ seed_vm_name_eff }}

    - name: Crear user-data (autoinstall)
      ansible.builtin.copy:
        dest: "{{ seed_local_dir }}/user-data"
        mode: "0644"
        content: |
          #cloud-config
          autoinstall:
            version: 1
            identity:
              hostname: {{ seed_vm_name_eff }}
              username: ansible
              # password = 'ansible'
              password: "$6$rounds=4096$7bQ1j2t1$eJz4zM7o3C1pWm9y1ZzF5o3N8m7gA0mQf8mCw3g8H6qYq7sZ0hQ2i2sC4cJ1qF/"
            locale: en_US.UTF-8
            keyboard: { layout: us, variant: "" }
            ssh:
              install-server: true
              authorized-keys:
                - "{{ ssh_pubkey }}"
              allow-pw: true
            packages:
              - qemu-guest-agent
              - open-vm-tools
            storage:
              layout: { name: direct }
            early-commands:
              - "systemctl disable --now snapd || true"
            late-commands:
              - "curtin in-target --target=/target -- sh -c \"echo 'ansible ALL=(ALL) NOPASSWD:ALL' >/etc/sudoers.d/90-ansible && chmod 0440 /etc/sudoers.d/90-ansible\""

    # ---------- Detección sin bash ----------
    - name: Probar candidatos de herramienta ISO
      ansible.builtin.stat:
        path: "{{ item }}"
      loop: "{{ iso_candidates }}"
      register: iso_stats

    - name: Elegir primera herramienta encontrada
      ansible.builtin.set_fact:
        iso_cmd: "{{ (iso_stats.results | selectattr('stat.exists') | map(attribute='stat.path') | list)[0] | default('') }}"

    - name: Fallar si no hay genisoimage/mkisofs
      ansible.builtin.fail:
        msg: "No se encontró genisoimage ni mkisofs en {{ iso_candidates }}. Instala uno (en OpenBSD: pkg_add cdrtools)."
      when: iso_cmd | length == 0

    - name: Crear ISO seed local con etiqueta cidata
      ansible.builtin.command: >
        {{ iso_cmd }}
        -output {{ seed_local_iso }}
        -volid cidata -joliet -rock
        meta-data user-data
      args:
        chdir: "{{ seed_local_dir }}"
      changed_when: true

    # ---------- (Opcional) Subida a vSphere ----------
    - name: Resolver parámetros vCenter (efectivos)
      ansible.builtin.set_fact:
        vcenter_hostname_eff: "{{ lookup('env','VCENTER_HOSTNAME') or (vcenter_hostname | default('')) }}"
        vcenter_username_eff: "{{ lookup('env','VCENTER_USERNAME') or (vcenter_username | default('')) }}"
        vcenter_password_eff: "{{ lookup('env','VCENTER_PASSWORD') or (vcenter_password | default('')) }}"
        vcenter_datacenter_eff: "{{ vcenter_datacenter | default('') }}"
        vcenter_datastore_eff: "{{ vcenter_datastore | default('')) }}"
        datastore_iso_dir_eff: "{{ datastore_iso_dir | default(datastore_iso_dir_default) }}"
        ubuntu_iso_filename_eff: "{{ ubuntu_iso_filename | default(ubuntu_iso_filename_default) }}"
        vcenter_validate_certs_eff: "{{ (vcenter_validate_certs | default(false)) | bool }}"
        vcenter_port_eff: "{{ (vcenter_port | default(443)) | int }}"
        seed_iso_filename_eff: "seed-{{ seed_vm_name_eff }}.iso"

    - name: Validar parámetros de vCenter para subida
      ansible.builtin.assert:
        that:
          - vcenter_hostname_eff | length > 0
          - vcenter_username_eff | length > 0
          - vcenter_password_eff | length > 0
          - vcenter_datacenter_eff | length > 0
          - vcenter_datastore_eff | length > 0
        fail_msg: "Faltan parámetros vCenter (hostname/username/password/datacenter/datastore)."
      when: seed_local_iso is exists

    - name: Subir ISO al datastore ({{ datastore_iso_dir_eff }}/{{ seed_iso_filename_eff }})
      community.vmware.vsphere_copy:
        hostname: "{{ vcenter_hostname_eff }}"
        username: "{{ vcenter_username_eff }}"
        password: "{{ vcenter_password_eff }}"
        validate_certs: "{{ vcenter_validate_certs_eff }}"
        datacenter: "{{ vcenter_datacenter_eff }}"
        datastore: "{{ vcenter_datastore_eff }}"
        src: "{{ seed_local_iso }}"
        path: "{{ datastore_iso_dir_eff }}/{{ seed_iso_filename_eff }}"
      when: seed_local_iso is exists