---
- name: Construir ISO seed para autoinstall ubuntu-seed-24-04
  hosts: localhost
  gather_facts: false

  vars:
    seed_vm_name: "ubuntu-seed-24-04"
    datastore_iso_dir: "ISOS"

    # Datos de red de la VM seed (ajusta si quieres)
    guest_ip: "192.168.5.85"
    guest_netmask: "255.255.255.0"
    guest_gateway: "192.168.5.252"
    guest_dns:
      - "192.168.10.2"
      - "1.1.1.1"

    linux_user: "ansible"
    linux_user_fullname: "Ansible Admin"
    ssh_pubkey_path: "/home/ansible/.ssh/id_ed25519.pub"

    vcenter_hostname: "192.168.5.150"
    vcenter_datacenter: "POPULAR_VALORES"
    vcenter_datastore: "PURESTORAGE_PV_X20R4_VOL_1"
    vcenter_username: "ansible_svc@vsphere.local"
    vcenter_validate_certs: false

    seed_iso_local_dir: "/tmp/seed-ubuntu-seed-24-04"
    seed_iso_local_path: "/tmp/seed-ubuntu-seed-24-04.iso"
    seed_iso_datastore_path: "ISOS/seed-ubuntu-seed-24-04.iso"

  pre_tasks:
    - name: Cargar vault.yml (password vCenter) si existe
      ansible.builtin.stat:
        path: "{{ playbook_dir }}/../vault.yml"
      register: vault_stat

    - name: include vault.yml
      ansible.builtin.include_vars:
        file: "{{ playbook_dir }}/../vault.yml"
      when: vault_stat.stat.exists
      no_log: true

    - name: Leer clave pública SSH
      ansible.builtin.slurp:
        src: "{{ ssh_pubkey_path }}"
      register: ssh_pubkey_raw

    - name: Decodificar clave pública SSH
      ansible.builtin.set_fact:
        ssh_pubkey: "{{ ssh_pubkey_raw.content | b64decode | trim }}"

  tasks:
    - name: Limpiar directorio local seed
      ansible.builtin.file:
        path: "{{ seed_iso_local_dir }}"
        state: absent

    - name: Crear directorio local seed
      ansible.builtin.file:
        path: "{{ seed_iso_local_dir }}"
        state: directory
        mode: "0755"

    - name: Crear meta-data
      ansible.builtin.copy:
        dest: "{{ seed_iso_local_dir }}/meta-data"
        mode: "0644"
        content: |
          instance-id: {{ seed_vm_name }}
          local-hostname: {{ seed_vm_name }}

    - name: Crear user-data (autoinstall)
      ansible.builtin.copy:
        dest: "{{ seed_iso_local_dir }}/user-data"
        mode: "0644"
        content: |
          #cloud-config
          autoinstall:
            version: 1
            identity:
              hostname: {{ seed_vm_name }}
              username: {{ linux_user }}
              realname: {{ linux_user_fullname }}
              password: "$6$rounds=4096$mtauto$9o6jlRrU7zR4GgPGNCUhlqPn1YW2bTEp2Yuzjzwy4uGDXnyxpaX8I6tWvjVfw3X2OZQbhHDpVPg2k1m6fYN5U0"  # 'P@ssw0rd' ejemplo
            ssh:
              install-server: true
              authorized-keys:
                - {{ ssh_pubkey }}
            keyboard:
              layout: "us"
            locale: "en_US.UTF-8"
            storage:
              layout:
                name: direct
            network:
              network:
                version: 2
                ethernets:
                  ens160:
                    dhcp4: false
                    addresses: [{{ guest_ip }}/24]
                    gateway4: {{ guest_gateway }}
                    nameservers:
                      addresses: [{{ guest_dns | join(', ') }}]
            packages:
              - qemu-guest-agent
              - open-vm-tools
            late-commands:
              - curtin in-target -- apt-get update
              - curtin in-target -- apt-get -y upgrade
            user-data:
              disable_root: true
          # fin

    - name: Crear ISO seed local con etiqueta cidata
      ansible.builtin.command:
        cmd: >
          genisoimage -output "{{ seed_iso_local_path }}"
          -volid cidata -joliet -rock
          meta-data user-data
      args:
        chdir: "{{ seed_iso_local_dir }}"
      changed_when: true

    - name: Subir ISO seed al datastore
      community.vmware.vsphere_copy:
        hostname: "{{ vcenter_hostname }}"
        username: "{{ vcenter_username }}"
        password: "{{ vcenter_password }}"
        validate_certs: "{{ vcenter_validate_certs }}"
        datacenter: "{{ vcenter_datacenter }}"
        datastore: "{{ vcenter_datastore }}"
        src: "{{ seed_iso_local_path }}"
        dest: "{{ seed_iso_datastore_path }}"