---
- name: Construir ISO seed para autoinstall ubuntu-seed-24-04
  hosts: localhost
  gather_facts: false

  vars:
    # Nombre por defecto del host/VM seed
    seed_vm_name: "{{ seed_vm_name | default('ubuntu-seed-24-04') }}"
    # Carpeta local temporal
    seed_local_dir: "/tmp/seed-{{ seed_vm_name }}"
    seed_local_iso: "/tmp/seed-{{ seed_vm_name }}.iso"

  pre_tasks:
    - name: Cargar vault.yml (password vCenter) si existe
      ansible.builtin.include_vars:
        file: "{{ playbook_dir }}/../vault.yml"
      no_log: true
      when: lookup('ansible.builtin.fileglob', playbook_dir + '/../vault.yml', errors='ignore') | length > 0

    # Resolver ssh_pubkey_path: ENV > all.yml > default
    - name: Resolver ssh_pubkey_path
      ansible.builtin.set_fact:
        ssh_pubkey_path: >-
          {{
            lookup('env','SSH_PUBKEY_PATH')
            or (ssh_pubkey_path | default('~/.ssh/id_ed25519.pub'))
          }}

    - name: Expandir y validar ssh_pubkey_path
      ansible.builtin.set_fact:
        ssh_pubkey_path_expanded: "{{ ssh_pubkey_path | expanduser }}"
    - name: Verificar existencia de clave pública SSH
      ansible.builtin.stat:
        path: "{{ ssh_pubkey_path_expanded }}"
      register: _pubkey_stat
    - name: Fallar si no existe la clave pública
      ansible.builtin.fail:
        msg: "No existe la clave pública en {{ ssh_pubkey_path_expanded }}. Define ssh_pubkey_path en all.yml o exporta SSH_PUBKEY_PATH, o crea la llave."
      when: not _pubkey_stat.stat.exists

  tasks:
    - name: Leer clave pública SSH
      ansible.builtin.slurp:
        src: "{{ ssh_pubkey_path_expanded }}"
      register: _pubkey_raw

    - name: Decodificar clave pública SSH
      ansible.builtin.set_fact:
        ssh_pubkey: "{{ _pubkey_raw.content | b64decode | trim }}"

    - name: Limpiar directorio local seed
      ansible.builtin.file:
        path: "{{ seed_local_dir }}"
        state: absent

    - name: Crear directorio local seed
      ansible.builtin.file:
        path: "{{ seed_local_dir }}"
        state: directory
        mode: "0755"

    - name: Crear meta-data
      ansible.builtin.copy:
        dest: "{{ seed_local_dir }}/meta-data"
        mode: "0644"
        content: |
          instance-id: {{ seed_vm_name }}
          local-hostname: {{ seed_vm_name }}

    - name: Crear user-data (autoinstall)
      ansible.builtin.copy:
        dest: "{{ seed_local_dir }}/user-data"
        mode: "0644"
        content: |
          #cloud-config
          autoinstall:
            version: 1
            identity:
              hostname: {{ seed_vm_name }}
              username: ansible
              password: "$6$rounds=4096$7bQ1j2t1$eJz4zM7o3C1pWm9y1ZzF5o3N8m7gA0mQf8mCw3g8H6qYq7sZ0hQ2i2sC4cJ1qF/"  # 'ansible' (cámbialo luego)
            locale: en_US.UTF-8
            keyboard: { layout: us, variant: "" }
            ssh:
              install-server: true
              authorized-keys:
                - "{{ ssh_pubkey }}"
              allow-pw: true
            packages:
              - qemu-guest-agent
              - open-vm-tools
            storage:
              layout:
                name: direct
            early-commands:
              - "systemctl disable --now snapd || true"
            late-commands:
              - "curtin in-target --target=/target -- sh -c \"echo 'ansible ALL=(ALL) NOPASSWD:ALL' >/etc/sudoers.d/90-ansible && chmod 0440 /etc/sudoers.d/90-ansible\""

    - name: Detectar comando para crear ISO (genisoimage o mkisofs)
      ansible.builtin.command: "bash -lc 'command -v genisoimage >/dev/null 2>&1 && echo genisoimage || (command -v mkisofs >/dev/null 2>&1 && echo mkisofs || echo NONE)'"
      register: _iso_cmd
      changed_when: false

    - name: Fallar si no hay herramienta para crear ISO
      ansible.builtin.fail:
        msg: "No se encontró genisoimage ni mkisofs. Instala uno: apt-get install genisoimage (Debian/Ubuntu) o pkg_add cdrtools (OpenBSD)."
      when: _iso_cmd.stdout == "NONE"

    - name: Crear ISO seed local con etiqueta cidata
      ansible.builtin.command: >
        {{ _iso_cmd.stdout }}
        -output {{ seed_local_iso }}
        -volid cidata -joliet -rock
        meta-data user-data
      args:
        chdir: "{{ seed_local_dir }}"
      changed_when: true

    # ====== Sección opcional: subir al datastore ======
    - name: Resolver parámetros mínimos de vCenter para subida
      ansible.builtin.set_fact:
        vcenter_hostname: "{{ lookup('env','VCENTER_HOSTNAME') or (vcenter_hostname | default('')) }}"
        vcenter_username: "{{ lookup('env','VCENTER_USERNAME') or (vcenter_username | default('')) }}"
        vcenter_password: "{{ lookup('env','VCENTER_PASSWORD') or (vcenter_password | default('')) }}"
        vcenter_datacenter: "{{ vcenter_datacenter | default('') }}"
        vcenter_datastore: "{{ vcenter_datastore | default('') }}"
        datastore_iso_dir: "{{ datastore_iso_dir | default('ISOS') }}"
        seed_iso_filename: "{{ seed_iso_filename | default('seed-' + (seed_vm_name | default('ubuntu-seed-24-04')) + '.iso') }}"
        vcenter_validate_certs: "{{ vcenter_validate_certs | default(false) }}"
        vcenter_port: "{{ (vcenter_port | default(443)) | int }}"

    - name: Validar parámetros de vCenter para subir ISO
      ansible.builtin.assert:
        that:
          - vcenter_hostname | length > 0
          - vcenter_username | length > 0
          - vcenter_password | length > 0
          - vcenter_datacenter | length > 0
          - vcenter_datastore | length > 0
        fail_msg: "Faltan parámetros de vCenter (hostname/username/password/datacenter/datastore)."
      when: seed_local_iso is exists

    - name: Subir ISO al datastore ({{ datastore_iso_dir }}/{{ seed_iso_filename }})
      community.vmware.vsphere_copy:
        hostname: "{{ vcenter_hostname }}"
        username: "{{ vcenter_username }}"
        password: "{{ vcenter_password }}"
        validate_certs: "{{ vcenter_validate_certs }}"
        datacenter: "{{ vcenter_datacenter }}"
        datastore: "{{ vcenter_datastore }}"
        src: "{{ seed_local_iso }}"
        path: "{{ datastore_iso_dir }}/{{ seed_iso_filename }}"
      when: seed_local_iso is exists