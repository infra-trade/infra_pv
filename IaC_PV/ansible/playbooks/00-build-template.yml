---
- name: Construir VM seed Ubuntu 24.04 por autoinstall en vSphere
  hosts: localhost
  connection: local
  gather_facts: false
  vars_files:
    - ../vault.yml

  vars:
    # venv para pyvmomi (evita PEP 668 en OpenBSD)
    vmware_venv: "{{ lookup('env','HOME') + '/.ansible/venvs/vmware' }}"
    venv_python: "{{ vmware_venv + '/bin/python3' }}"

    # Forzamos vars ISO aqu√≠ (usando ISO ya en datastore)
    ubuntu_iso_url: ""
    ubuntu_iso_local: ""
    datastore_iso_dir: "ISOS"
    existing_datastore_iso: "[PURESTORAGE_PV_X20R4_VOL_1] ISOS/ubuntu-24.04.3-live-server-amd64.iso"

  pre_tasks:
    - name: Crear venv para m√≥dulos VMware (si no existe)
      delegate_to: localhost
      become: false
      ansible.builtin.command:
        cmd: "python3 -m venv {{ vmware_venv }}"
      args:
        creates: "{{ venv_python }}"

    - name: Actualizar pip en el venv
      delegate_to: localhost
      become: false
      ansible.builtin.pip:
        name: pip
        state: latest
        virtualenv: "{{ vmware_venv }}"

    # üîß NUEVO: dependencias Python que requieren los m√≥dulos VMware
    - name: Instalar dependencias de VMware en el venv
      delegate_to: localhost
      become: false
      ansible.builtin.pip:
        name:
          - "pyvmomi>=8.0.2"
          - "requests>=2.31.0"
          - "urllib3>=1.26"     # si tu entorno tiene problemas con urllib3 v2, cambia a '<2'
        virtualenv: "{{ vmware_venv }}"

    - name: Usar el Python del venv para el resto del play
      set_fact:
        ansible_python_interpreter: "{{ venv_python }}"

    # ====== Resolver credenciales/endpoint de vCenter ======
    - name: Resolver endpoint vCenter (hostname) desde vars/env/vault
      set_fact:
        vcenter_hostname: >-
          {{
            (vcenter_hostname | default('', true))
            | default(lookup('env','VCENTER_HOSTNAME'), true)
            | default('', true)
          }}

    - name: Resolver usuario vCenter desde vars/env/vault
      no_log: true
      set_fact:
        vcenter_username: >-
          {{
            (vcenter_username | default('', true))
            | default(lookup('env','VCENTER_USERNAME'), true)
            | default(vault_vcenter_username | default('', true), true)
            | default('', true)
          }}

    - name: Resolver password vCenter desde vars/env/vault
      no_log: true
      set_fact:
        vcenter_password: >-
          {{
            (vcenter_password | default('', true))
            | default(lookup('env','VCENTER_PASSWORD'), true)
            | default(vault_vcenter_password | default('', true), true)
            | default('', true)
          }}

    - name: Validar credenciales y endpoint de vCenter
      assert:
        that:
          - (vcenter_hostname | length) > 0
          - (vcenter_username | length) > 0
          - (vcenter_password | length) > 0
        fail_msg: >-
          Faltan par√°metros de vCenter.
          hostname='{{ vcenter_hostname | default('') }}'
          username='{{ vcenter_username | default('') }}'
          Define en group_vars/all.yml o en vault.yml
          (o exporta VCENTER_HOSTNAME/VCENTER_USERNAME/VCENTER_PASSWORD).

  roles:
    - role: ubuntu_autoinstall_vsphere