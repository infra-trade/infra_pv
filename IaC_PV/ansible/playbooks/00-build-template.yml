---
- name: Construir VM seed Ubuntu 24.04 por autoinstall en vSphere
  hosts: localhost
  gather_facts: false
  connection: local

  vars:
    vmware_venv_path: "/home/ansible/.ansible/venvs/vmware"

  pre_tasks:
    #################################################################
    # 0) Preparar venv para módulos VMware
    #################################################################
    - name: Crear venv para módulos VMware (si no existe)
      ansible.builtin.command: "python3 -m venv {{ vmware_venv_path }}"
      args:
        creates: "{{ vmware_venv_path }}/bin/python3"

    - name: Actualizar pip en el venv
      ansible.builtin.command: "{{ vmware_venv_path }}/bin/pip install --upgrade pip"
      changed_when: false

    - name: Instalar dependencias de VMware en el venv
      ansible.builtin.command: >
        {{ vmware_venv_path }}/bin/pip install
        --disable-pip-version-check
        pyvmomi
        requests
      changed_when: false

    - name: Usar el Python del venv para el resto del play
      ansible.builtin.set_fact:
        ansible_python_interpreter: "{{ vmware_venv_path }}/bin/python3"

    #################################################################
    # 1) Resolver credenciales / endpoint vCenter
    #    Precedencia:
    #      ENV > vault_* > valores ya definidos (group_vars/all.yml)
    #################################################################

    - name: Resolver endpoint vCenter (hostname) desde vars/env/vault
      ansible.builtin.set_fact:
        _vc_hostname_env: "{{ lookup('env', 'VCENTER_HOSTNAME') | default('', true) }}"
        _vc_username_env: "{{ lookup('env', 'VCENTER_USERNAME') | default('', true) }}"
        _vc_password_env: "{{ lookup('env', 'VCENTER_PASSWORD') | default('', true) }}"
        _vc_hostname_vault: "{{ vault_vcenter_hostname | default('', true) }}"
        _vc_username_vault: "{{ vault_vcenter_username | default('', true) }}"
        _vc_password_vault: "{{ vault_vcenter_password | default('', true) }}"

    - name: Consolidar parámetros efectivos de vCenter
      ansible.builtin.set_fact:
        vcenter_hostname: >-
          {{
            _vc_hostname_env
            or _vc_hostname_vault
            or vcenter_hostname | default('', true)
          }}
        vcenter_username: >-
          {{
            _vc_username_env
            or _vc_username_vault
            or vcenter_username | default('', true)
          }}
        vcenter_password: >-
          {{
            _vc_password_env
            or _vc_password_vault
            or vcenter_password | default('', true)
          }}

    - name: Validar credenciales y endpoint de vCenter
      ansible.builtin.assert:
        that:
          - (vcenter_hostname | default('')) | length > 0
          - (vcenter_username | default('')) | length > 0
          - (vcenter_password | default('')) | length > 0
        fail_msg: >-
          Faltan parámetros de vCenter. hostname='{{ vcenter_hostname | default('') }}'
          username='{{ vcenter_username | default('') }}'
          Define en group_vars/all.yml o en vault.yml
          (o exporta VCENTER_HOSTNAME/VCENTER_USERNAME/VCENTER_PASSWORD).
        success_msg: "Parámetros de vCenter OK."

  roles:
    - role: ubuntu_autoinstall_vsphere