---
- name: Construir VM seed Ubuntu 24.04 por autoinstall en vSphere
  hosts: localhost
  connection: local
  gather_facts: false
  vars_files:
    - ../vault.yml

  vars:
    # venv para pyvmomi (evita PEP 668 en OpenBSD)
    vmware_venv: "{{ lookup('env','HOME') + '/.ansible/venvs/vmware' }}"
    venv_python: "{{ vmware_venv + '/bin/python3' }}"

    # üîí Forzamos aqu√≠ las vars del ISO para evitar "undefined"
    ubuntu_iso_url: ""          # deja vac√≠o (usaremos el ISO que ya est√° en el datastore)
    ubuntu_iso_local: ""        # si quisieras usar un ISO local, coloca aqu√≠ la ruta absoluta
    datastore_iso_dir: "ISOS"   # carpeta del datastore donde est√°n los ISOs
    existing_datastore_iso: "[PURESTORAGE_PV_X20R4_VOL_1] ISOS/ubuntu-24.04.3-live-server-amd64.iso"

  pre_tasks:
    - name: Crear venv para m√≥dulos VMware (si no existe)
      delegate_to: localhost
      become: false
      ansible.builtin.command:
        cmd: "python3 -m venv {{ vmware_venv }}"
      args:
        creates: "{{ venv_python }}"

    - name: Actualizar pip en el venv
      delegate_to: localhost
      become: false
      ansible.builtin.pip:
        name: pip
        state: latest
        virtualenv: "{{ vmware_venv }}"

    - name: Instalar pyvmomi en el venv
      delegate_to: localhost
      become: false
      ansible.builtin.pip:
        name: pyvmomi
        virtualenv: "{{ vmware_venv }}"

    - name: Usar el Python del venv para el resto del play
      set_fact:
        ansible_python_interpreter: "{{ venv_python }}"

  roles:
    - role: ubuntu_autoinstall_vsphere