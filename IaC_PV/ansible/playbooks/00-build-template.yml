---
- name: Construir VM seed Ubuntu 24.04 por autoinstall en vSphere
  hosts: localhost
  gather_facts: false

  vars_files:
    - ../group_vars/all.yml
    - ../vault.yml

  pre_tasks:
    - name: Crear venv para módulos VMware (si no existe)
      ansible.builtin.command: python3 -m venv /home/ansible/.ansible/venvs/vmware
      args:
        creates: /home/ansible/.ansible/venvs/vmware/bin/python3

    - name: Actualizar pip en el venv
      ansible.builtin.command: /home/ansible/.ansible/venvs/vmware/bin/pip install --upgrade pip
      changed_when: false

    - name: Instalar dependencias de VMware en el venv
      ansible.builtin.command: /home/ansible/.ansible/venvs/vmware/bin/pip install pyvmomi requests
      changed_when: false

    - name: Usar el Python del venv para el resto del play
      set_fact:
        ansible_python_interpreter: "/home/ansible/.ansible/venvs/vmware/bin/python3"

    - name: Resolver endpoint/credenciales desde entorno y vault
      set_fact:
        vcenter_hostname: "{{ (lookup('env','VCENTER_HOSTNAME') | default(vcenter_hostname, true)) | default('', true) }}"
        vcenter_username: "{{ (lookup('env','VCENTER_USERNAME') | default(vcenter_username, true)) | default('', true) }}"
        vcenter_password: >-
          {{ (lookup('env','VCENTER_PASSWORD') | default(vcenter_password, true))
             | default('', true) }}

    - name: Consolidar parámetros efectivos de vCenter
      set_fact:
        _vc_effective:
          hostname: "{{ vcenter_hostname | default('') }}"
          username: "{{ vcenter_username | default('') }}"
          password_from_vault: "{{ 'YES' if (vcenter_password | default('') | length > 0) else 'NO' }}"

    - name: Mostrar parámetros efectivos de vCenter (debug)
      debug:
        msg: "{{ _vc_effective }}"

    - name: Validar credenciales y endpoint de vCenter
      assert:
        that:
          - (vcenter_hostname | default('')) | length > 0
          - (vcenter_username | default('')) | length > 0
          - (vcenter_password | default('')) | length > 0
        fail_msg: "Faltan parámetros de vCenter. hostname='{{ vcenter_hostname | default('') }}' username='{{ vcenter_username | default('') }}'. Define en group_vars/all.yml o en vault.yml o exporta VCENTER_*."
        success_msg: "Parámetros de vCenter OK."

  roles:
    - ubuntu_autoinstall_vsphere