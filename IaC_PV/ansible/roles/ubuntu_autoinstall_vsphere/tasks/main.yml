---
# 0) Facts del controlador
- name: Gather facts on localhost
  setup:
  delegate_to: localhost
  become: false

# 1) Instalar dependencias del SO según plataforma
- name: Instalar dependencias en OpenBSD
  package:
    name:
      - py3-pip
      - cdrtools      # provee mkisofs
      - xorriso
    state: present
  become: true
  when: ansible_facts['os_family'] == 'OpenBSD'

- name: Instalar dependencias en Debian/Ubuntu
  apt:
    name:
      - python3-pip
      - genisoimage   # provee mkisofs
      - xorriso
    state: present
    update_cache: true
  become: true
  when: ansible_facts['os_family'] == 'Debian'

- name: Instalar dependencias en RedHat/CentOS
  yum:
    name:
      - python3-pip
      - genisoimage
      - xorriso
    state: present
  become: true
  when: ansible_facts['os_family'] == 'RedHat'

# 2) Normalizar variables y banderas (evita problemas de tipos)
- name: Normalizar variables de ISO (strings)
  set_fact:
    _iso_url: "{{ ubuntu_iso_url | default('') | string }}"
    _iso_local: "{{ ubuntu_iso_local | default('') | string }}"
    _iso_existing: "{{ existing_datastore_iso | default('') | string }}"
    _iso_dir: "{{ datastore_iso_dir | default('iso') | string }}"

- name: Calcular banderas de origen de ISO
  set_fact:
    use_url: "{{ (_iso_url | length) > 0 }}"
    use_local: "{{ (_iso_local | length) > 0 }}"
    use_existing: "{{ (_iso_existing | length) > 0 }}"

- name: Validar que exista alguna fuente de ISO
  assert:
    that:
      - use_url or use_local or use_existing
    fail_msg: "Define ubuntu_iso_url o ubuntu_iso_local, o bien existing_datastore_iso ('[DATASTORE] carpeta/archivo.iso')."

# 3) Preparar nombre y path del ISO (cuando NO usamos existing)
- name: Inicializar variables de ISO calculadas
  set_fact:
    ubuntu_iso_filename: ""
    ubuntu_iso_local_path: ""
  when: not use_existing

- name: Calcular filename/local_path desde URL
  set_fact:
    ubuntu_iso_filename: "{{ _iso_url | basename }}"
    ubuntu_iso_local_path: "{{ lookup('env','HOME') }}/.cache/ansible/{{ _iso_url | basename }}"
  when:
    - not use_existing
    - use_url

- name: Calcular filename/local_path desde ruta local
  set_fact:
    ubuntu_iso_filename: "{{ _iso_local | basename }}"
    ubuntu_iso_local_path: "{{ _iso_local }}"
  when:
    - not use_existing
    - use_local

- name: Asegurar que filename/local_path quedaron definidos si no usamos existing
  assert:
    that:
      - ubuntu_iso_filename | length > 0
      - ubuntu_iso_local_path | length > 0
  when: not use_existing

# 4) Descargar ISO si viene por URL
- name: Descargar ISO Ubuntu si hay URL
  delegate_to: localhost
  when:
    - use_url
    - not use_existing
  get_url:
    url: "{{ _iso_url }}"
    dest: "{{ ubuntu_iso_local_path }}"
    mode: "0644"
    force: no

# 5) Subir ISO Ubuntu al datastore (si no usamos el existente)
- name: Subir ISO Ubuntu al datastore
  community.vmware.vsphere_copy:
    hostname: "{{ vcenter_hostname }}"
    username: "{{ vcenter_username }}"
    password: "{{ vcenter_password }}"
    validate_certs: "{{ vcenter_validate_certs }}"
    src: "{{ ubuntu_iso_local_path }}"
    datacenter: "{{ vcenter_datacenter }}"
    datastore: "{{ vcenter_datastore }}"
    path: "{{ _iso_dir }}/{{ ubuntu_iso_filename }}"
  when: not use_existing

# 6) Preparar seed cloud-init local
- name: Preparar seed cloud-init local
  delegate_to: localhost
  file:
    path: "/tmp/seed-{{ seed_vm_name }}"
    state: directory
    mode: "0755"

- name: Cargar llave pública
  delegate_to: localhost
  set_fact:
    ssh_pubkey_content: "{{ lookup('file', ssh_pubkey_path | expanduser) }}"

- name: Calcular máscara en bits
  set_fact:
    mask_bits: "{{ (guest_netmask | ipaddr('prefix')) }}"

- name: Renderizar user-data/meta-data
  delegate_to: localhost
  block:
    - name: user-data
      template:
        src: "templates/user-data.j2"
        dest: "/tmp/seed-{{ seed_vm_name }}/user-data"
        mode: "0644"
      vars:
        hostname: "{{ seed_vm_name }}"
        host_ip: "192.168.5.250"   # IP temporal para seed
        mask_bits: "{{ mask_bits }}"
        ssh_key: "{{ ssh_pubkey_content }}"
    - name: meta-data
      template:
        src: "templates/meta-data.j2"
        dest: "/tmp/seed-{{ seed_vm_name }}/meta-data"
        mode: "0644"
      vars:
        hostname: "{{ seed_vm_name }}"

# 7) Crear seed ISO (NoCloud) con mkisofs
- name: Crear seed ISO (NoCloud) con mkisofs
  delegate_to: localhost
  command:
    cmd: >
      mkisofs -output /tmp/seed-{{ seed_vm_name }}.iso
      -V cidata -J -R
      /tmp/seed-{{ seed_vm_name }}/user-data
      /tmp/seed-{{ seed_vm_name }}/meta-data
    creates: "/tmp/seed-{{ seed_vm_name }}.iso"

# 8) Subir seed ISO al datastore
- name: Subir seed ISO al datastore
  community.vmware.vsphere_copy:
    hostname: "{{ vcenter_hostname }}"
    username: "{{ vcenter_username }}"
    password: "{{ vcenter_password }}"
    validate_certs: "{{ vcenter_validate_certs }}"
    src: "/tmp/seed-{{ seed_vm_name }}.iso"
    datacenter: "{{ vcenter_datacenter }}"
    datastore: "{{ vcenter_datastore }}"
    path: "{{ _iso_dir }}/seed-{{ seed_vm_name }}.iso"

# 9) Crear VM seed y montar ISOs
- name: Crear VM seed y montar ISOs
  community.vmware.vmware_guest:
    hostname: "{{ vcenter_hostname }}"
    username: "{{ vcenter_username }}"
    password: "{{ vcenter_password }}"
    validate_certs: "{{ vcenter_validate_certs }}"
    datacenter: "{{ vcenter_datacenter }}"
    cluster: "{{ vcenter_cluster }}"
    folder: "{{ vm_folder | default(omit) }}"
    name: "{{ seed_vm_name }}"
    state: poweredon
    guest_id: "ubuntu64Guest"
    hardware:
      memory_mb: "{{ vm_ram_mb }}"
      num_cpus: "{{ vm_cpu }}"
      scsi: paravirtual
      boot_firmware: efi
      boot_order:
        - cdrom
        - disk
        - ethernet
    networks:
      - name: "{{ vcenter_network }}"
    disk:
      - size_gb: "{{ vm_disk_gb }}"
        type: thin
        autoselect_datastore: false
        datastore: "{{ vcenter_datastore }}"
    cdrom:
      - type: iso
        iso_path: >-
          {{
            use_existing
              | ternary(
                  _iso_existing,
                  "[{{ vcenter_datastore }}] {{ _iso_dir }}/{{ ubuntu_iso_filename }}"
                )
          }}
        controller_number: 0
        unit_number: 0
      - type: iso
        iso_path: "[{{ vcenter_datastore }}] {{ _iso_dir }}/seed-{{ seed_vm_name }}.iso"
        controller_number: 0
        unit_number: 1
    wait_for_ip_address: no

# 10) Espera simple a que finalice autoinstall (ajusta según tu entorno)
- name: Espera razonable a que finalice autoinstall
  pause:
    minutes: 15

# 11) Desmontar CDROMs y apagar VM seed
- name: Desmontar CDROMs
  community.vmware.vmware_guest:
    hostname: "{{ vcenter_hostname }}"
    username: "{{ vcenter_username }}"
    password: "{{ vcenter_password }}"
    validate_certs: "{{ vcenter_validate_certs }}"
    datacenter: "{{ vcenter_datacenter }}"
    name: "{{ seed_vm_name }}"
    cdrom:
      - type: none
        state: present
        controller_number: 0
        unit_number: 0
      - type: none
        state: present
        controller_number: 0
        unit_number: 1

- name: Apagar VM seed
  community.vmware.vmware_guest:
    hostname: "{{ vcenter_hostname }}"
    username: "{{ vcenter_username }}"
    password: "{{ vcenter_password }}"
    validate_certs: "{{ vcenter_validate_certs }}"
    datacenter: "{{ vcenter_datacenter }}"
    name: "{{ seed_vm_name }}"
    state: poweredoff
    state_change_timeout: 1200