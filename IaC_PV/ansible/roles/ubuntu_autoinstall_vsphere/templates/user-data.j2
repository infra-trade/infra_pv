#cloud-config

hostname: {{ hostname }}
manage_etc_hosts: true
fqdn: {{ hostname }}.{{ guest_domain | default('localdomain') }}

# Usuario inicial con sudo sin password (puedes cambiarlo luego)
users:
  - name: {{ linux_user }}
    gecos: "{{ linux_user | capitalize }}"
    groups: [adm, cdrom, dip, plugdev, lxd, sudo]
    shell: /bin/bash
    sudo: ["ALL=(ALL) NOPASSWD:ALL"]
    lock_passwd: true
    ssh_authorized_keys:
      - "{{ ssh_key }}"

ssh_pwauth: {{ (disable_password_ssh | default(true)) | ternary('false','true') }}

# Netplan estático temporal para el proceso de instalación
# (No se usará en la plantilla final; la VM seed se apaga y convertimos a template)
network:
  version: 2
  ethernets:
    {{ net_interface }}:
      dhcp4: false
      addresses:
        - {{ host_ip }}/{{ mask_bits }}
      gateway4: {{ guest_gateway }}
      nameservers:
        addresses: [{% for d in guest_dns_servers %}{{ d }}{% if not loop.last %}, {% endif %}{% endfor %}]

# Paquetes mínimos útiles (puedes quitar si no los quieres en la seed)
packages:
  - qemu-guest-agent
  - ca-certificates
  - curl

# Actualizaciones durante el primer boot
package_update: true
package_upgrade: true

# Deshabilitar cloud-init al finalizar para que la plantilla no regenere en cada clon
runcmd:
  - systemctl enable qemu-guest-agent || true
  - systemctl start qemu-guest-agent || true
  - touch /etc/cloud/cloud-init.disabled

# Minimiza logs de cloud-init
final_message: "Cloud-init finalizado en {{ hostname }}"